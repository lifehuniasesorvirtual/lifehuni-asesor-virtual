<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Lifehuni - Experto Asesor Virtual en Suplementos</title>
<style>
        /* [TODOS LOS ESTILOS EXISTENTES] */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 40px;
            width: 100%;
            max-width: 420px;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo-container {
            text-align: center;
            margin-bottom: 15px;
            perspective: 1000px;
        }

        .rotating-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            animation: rotateHorizontal 4s linear infinite;
            box-shadow: 0 8px 25px rgba(46, 139, 87, 0.4);
            transition: all 0.3s ease;
            transform-style: preserve-3d;
        }

        .rotating-logo:hover {
            animation-duration: 1.5s;
            box-shadow: 0 12px 30px rgba(46, 139, 87, 0.6);
        }

        @keyframes rotateHorizontal {
            from {
                transform: rotateY(0deg);
            }
            to {
                transform: rotateY(360deg);
            }
        }

        .logo h1 {
            color: #2E8B57;
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .logo .subtitle {
            color: #228B22;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .logo .tagline {
            color: #666;
            font-size: 14px;
            font-style: italic;
        }

        .form-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-toggle {
            display: flex;
            background: #f1f3f4;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 10px;
        }

        .form-toggle button {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .form-toggle button.active {
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: #2E8B57;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }

        .form-group label {
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .form-group input {
            padding: 12px 45px 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            width: 100%;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2E8B57;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 35px;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 18px;
            padding: 5px;
            border-radius: 4px;
            transition: color 0.3s ease;
        }

        .password-toggle:hover {
            color: #2E8B57;
            background: #f0f8f0;
        }

        .btn {
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            margin-top: 15px;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .device-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 12px;
            color: #666;
            text-align: center;
            border-left: 4px solid #2E8B57;
        }

        .features {
            margin-top: 25px;
            padding: 15px;
            background: #f0f8f0;
            border-radius: 8px;
            border-left: 4px solid #228B22;
        }

        .features h3 {
            color: #2E8B57;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .features ul {
            list-style: none;
            font-size: 12px;
            color: #555;
        }

        .features li {
            margin-bottom: 5px;
            padding-left: 15px;
            position: relative;
        }

        .features li:before {
            content: "‚úì";
            color: #2E8B57;
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .fingerprint-status {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 12px;
            color: #2E8B57;
            text-align: center;
            border: 1px solid #c3e6cb;
            display: none;
        }

        .new-device-alert {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 12px;
            color: #856404;
            text-align: center;
            border: 1px solid #ffeaa7;
        }

        /* ESTILOS MEJORADOS PARA EL DASHBOARD */
        .dashboard-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            font-family: 'Arial', sans-serif;
        }

        .dashboard-header {
            background: white;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .brand-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .dashboard-logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(46, 139, 87, 0.3);
        }

        .dashboard-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .brand-text {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand-text h1 {
            color: #2E8B57;
            font-size: 24px;
            margin: 0;
        }

        .premium-badge {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }

        .user-section {
            position: relative;
        }

        .user-info-dropdown {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 20px;
            transition: background 0.3s ease;
            position: relative;
        }

        .user-info-dropdown:hover {
            background: #f0f8f0;
        }

        .user-avatar {
            font-size: 20px;
        }

        .user-email {
            font-weight: 500;
            color: #333;
        }

        .dropdown-arrow {
            font-size: 12px;
            color: #666;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
            border-radius: 12px;
            padding: 20px;
            min-width: 250px;
            z-index: 1001;
        }

        .user-stats {
            margin-bottom: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .stat-label {
            color: #666;
        }

        .stat-value {
            font-weight: 500;
        }

        .status-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .dropdown-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .dashboard-main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
            display: grid;
            gap: 25px;
        }

        .welcome-section {
            grid-column: 1 / -1;
        }

        .welcome-card {
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }

        .welcome-card h2 {
            margin-bottom: 10px;
            font-size: 24px;
        }

        .welcome-features {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .feature-icon {
            font-size: 18px;
        }

        .access-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .panel-header {
            margin-bottom: 20px;
        }

        .panel-header h3 {
            color: #2E8B57;
            margin-bottom: 5px;
        }

        .access-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .access-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .access-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-color: #2E8B57;
        }

        .access-card.primary {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            border-color: #2E8B57;
        }

        .card-icon {
            font-size: 30px;
        }

        .card-content {
            flex: 1;
        }

        .card-content h4 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .card-content p {
            margin: 0;
            color: #666;
            font-size: 12px;
        }

        .access-badge {
            background: #ffc107;
            color: #000;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
            margin-top: 5px;
            display: inline-block;
        }

        .card-arrow {
            font-size: 20px;
            color: #2E8B57;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
        }

        .stat-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .stat-info h3 {
            margin: 0;
            color: #2E8B57;
            font-size: 20px;
        }

        .stat-info p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 12px;
        }

        .notification-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .notification-header h3 {
            margin: 0;
            color: #2E8B57;
        }

        .notification-badge {
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .notification-item {
            display: flex;
            gap: 15px;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .notification-item:hover {
            background: #f8f9fa;
        }

        .notification-item.new {
            background: #e8f5e8;
        }

        .notification-icon {
            font-size: 18px;
        }

        .notification-content p {
            margin: 0;
        }

        .notification-time {
            font-size: 10px;
            color: #999;
            margin-top: 5px;
        }

        .dashboard-footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 12px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        /* ESTILOS PARA SISTEMA DE TOKENS */
        .subscription-section {
            margin: 25px 0;
        }

        .subscription-alert {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        .subscription-alert.normal {
            background: #e8f5e8;
            border-left: 4px solid #2E8B57;
        }

        .subscription-alert.alert {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .subscription-alert.warning {
            background: #ffeaa7;
            border-left: 4px solid #f39c12;
        }

        .subscription-alert.urgent {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            animation: urgentPulse 1s infinite;
        }

        .alert-icon {
            font-size: 24px;
        }

        .alert-content h4 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .alert-content p {
            margin: 0 0 10px 0;
            color: #666;
        }

        .renew-btn {
            background: #2E8B57;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .renew-btn:hover {
            background: #228B22;
        }

        .tokens-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .tokens-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .token-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .token-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .token-card.primary {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            border-color: #2E8B57;
        }

        .token-icon {
            font-size: 30px;
            margin-bottom: 10px;
        }

        .token-info h3 {
            margin: 0;
            color: #2E8B57;
            font-size: 24px;
        }

        .token-info p {
            margin: 5px 0;
            color: #333;
            font-weight: 500;
        }

        .token-info small {
            color: #666;
            font-size: 11px;
        }

        .warning-text {
            color: #dc3545 !important;
        }

        .token-progress {
            margin-top: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 10px;
            color: #666;
            margin-top: 5px;
            display: block;
        }

        /* ESTILOS PARA PANTALLA DE SUSCRIPCI√ìN VENCIDA */
        .expired-screen {
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            text-align: center;
        }

        .warning-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        .renewal-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
            max-width: 800px;
            width: 100%;
        }

        .plan-option {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .plan-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .plan-option.recommended {
            border-color: #2E8B57;
            background: linear-gradient(135deg, #f0f8f0 0%, #e8f5e8 100%);
            position: relative;
        }

        .plan-option.recommended::before {
            content: "RECOMENDADO";
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: #2E8B57;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .support-text {
            margin-top: 20px;
            color: #666;
        }

        .support-text a {
            color: #2E8B57;
            text-decoration: none;
            font-weight: 500;
        }

        /* ESTILOS PARA EL SISTEMA DE CHAT GPT */
        #gptModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 800px;
            height: 80%;
            background: white;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .modal-header p {
            margin: 5px 0 0 0;
            font-size: 12px;
            opacity: 0.9;
        }

        #closeModal {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #closeModal:hover {
            background: rgba(255,255,255,0.2);
        }

        #chatContainer {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f8f9fa;
        }

        .chat-message {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease;
        }

        .chat-message.user-message {
            justify-content: flex-end;
        }

        .chat-message.user-message .message-content {
            background: #e3f2fd;
            border-radius: 15px 15px 5px 15px;
        }

        .chat-message.bot-message .message-content {
            background: #f5f5f5;
            border-radius: 15px 15px 15px 5px;
        }

        .message-content {
            padding: 12px 15px;
            max-width: 70%;
            position: relative;
        }

        .message-content strong {
            display: block;
            font-size: 12px;
            color: #2E8B57;
            margin-bottom: 5px;
        }

        .message-content p {
            margin: 0;
            line-height: 1.4;
        }

        .message-time {
            font-size: 10px;
            color: #999;
            display: block;
            margin-top: 5px;
        }

        .message-avatar {
            font-size: 20px;
            align-self: flex-end;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #999;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            background: white;
            border-radius: 0 0 15px 15px;
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        #userMessage {
            flex: 1;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }

        #userMessage:focus {
            outline: none;
            border-color: #2E8B57;
        }

        #sendMessage {
            background: #2E8B57;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        #sendMessage:hover {
            background: #228B22;
        }

        .security-notice {
            font-size: 10px;
            color: #666;
            text-align: center;
            margin: 10px 0 0 0;
        }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        @keyframes urgentPulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-10px);}
            60% {transform: translateY(-5px);}
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .dashboard-main {
                padding: 20px 15px;
            }

            .welcome-features {
                flex-direction: column;
                gap: 15px;
            }

            .access-grid {
                grid-template-columns: 1fr;
            }

            .tokens-grid {
                grid-template-columns: 1fr;
            }

            .renewal-options {
                grid-template-columns: 1fr;
            }

            .user-email {
                display: none;
            }

            .modal-content {
                width: 95%;
                height: 90%;
            }

            .message-content {
                max-width: 85%;
            }
        }
/* üåø Estilo de notificaci√≥n flotante centrado LifeHuni */
#toastContainer {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 2000;
  width: 90%;
  max-width: 450px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.toast {
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
  border-radius: 10px;
  padding: 16px 18px;
  margin-top: 10px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
  font-size: 16px;
  line-height: 1.4;
  font-family: 'Segoe UI', sans-serif;
  animation: fadeInOut 5s ease forwards;
  text-align: center;
}

.toast .icon {
  margin-right: 10px;
  font-size: 22px;
}

@keyframes fadeInOut {
  0% { opacity: 0; transform: scale(0.95); }
  10%, 90% { opacity: 1; transform: scale(1); }
  100% { opacity: 0; transform: scale(0.95); }
}

</style>
</head>
<body>
    
<!-- üåø Contenedor para notificaciones flotantes -->
<div id="toastContainer" style="
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 2000;
"></div>

<div class="container">
<div class="logo">
<div class="logo-container">
<img alt="Lifehuni Logo" class="rotating-logo" src="logo-lifehuni.png"/>
</div>
<h1>LIFEHUNI</h1>
<div class="subtitle">Experto Asesor Virtual</div>
<div class="tagline">Suplementos Dietarios &amp; Nutrici√≥n</div>
</div>
<div class="form-container">
<div class="form-toggle">
<button class="active" id="loginBtn">Iniciar Sesi√≥n</button>
<button id="registerBtn">Registrarse</button>
</div>
<!-- Formulario de Login -->
<form id="loginForm">
<div class="form-group">
<label for="loginEmail">Correo Electr√≥nico</label>
<input id="loginEmail" required="" type="email"/>
</div>
<div class="form-group">
<label for="loginPassword">Contrase√±a</label>
<input id="loginPassword" required="" type="password"/>
<button class="password-toggle" data-target="loginPassword" type="button">
                        üëÅÔ∏è
                    </button>
</div>
<!-- Alerta de nuevo dispositivo -->
<div class="new-device-alert" id="newDeviceAlert" style="display: none;">
<strong>‚ö†Ô∏è Dispositivo no reconocido</strong><br/>
                    Este es un nuevo dispositivo. El administrador ha sido notificado para autorizar el acceso.
                </div>
<button class="btn" id="loginButton" type="submit">
<span id="loginText">Ingresar al Asesor Virtual</span>
<span class="loading" id="loginLoading" style="display: none;"></span>
</button>
<p style="text-align:center; margin-top:10px;">
  <a href="#" id="forgotPasswordLink" style="color:#2E8B57; text-decoration:none;">¬øOlvidaste tu contrase√±a?</a>
</p>

</form>

<!-- Formulario de Registro -->
<form id="registerForm" style="display: none;">
    <!-- ‚úÖ NUEVOS CAMPOS AGREGADOS -->
    <div class="form-group">
        <label for="registerName">Nombres</label>
        <input id="registerName" required type="text" placeholder="Tu nombre"/>
    </div>
    <div class="form-group">
        <label for="registerLastName">Apellidos</label>
        <input id="registerLastName" required type="text" placeholder="Tu apellido"/>
    </div>
    <div class="form-group">
        <label for="registerPhone">Tel√©fono</label>
        <input id="registerPhone" required type="tel" placeholder="Ej: 3001234567"/>
    </div>
    
    <!-- üéØ CAMPOS EXISTENTES (NO TOCAR) -->
    <div class="form-group">
        <label for="registerEmail">Correo Electr√≥nico</label>
        <input id="registerEmail" required="" type="email"/>
    </div>
    <div class="form-group">
        <label for="registerPassword">Contrase√±a</label>
        <input id="registerPassword" minlength="6" required="" type="password"/>
        <button class="password-toggle" data-target="registerPassword" type="button">
            üëÅÔ∏è
        </button>
    </div>
    <div class="form-group">
        <label for="confirmPassword">Confirmar Contrase√±a</label>
        <input id="confirmPassword" required="" type="password"/>
        <button class="password-toggle" data-target="confirmPassword" type="button">
            üëÅÔ∏è
        </button>
    </div>
<!-- Estado del Fingerprinting -->
<div class="fingerprint-status" id="fingerprintStatus">
                    üîí Detectando dispositivo...
                </div>
<button class="btn" id="registerButton" type="submit">
<span id="registerText">Crear Cuenta Lifehuni</span>
<span class="loading" id="registerLoading" style="display: none;"></span>
</button>
</form>
<div class="message" id="message" style="display: none;"></div>
</div>
<div class="features">
<h3>‚úÖ Tu Asesor Virtual Incluye:</h3>
<ul>
<li>Recomendaciones personalizadas de suplementos</li>
<li>Planificaci√≥n nutricional especializada</li>
<li>Asesor√≠a 24/7 sobre suplementaci√≥n</li>
<li>Acceso desde cualquier dispositivo autorizado</li>
</ul>
</div>
<div class="device-info">
<p>üîí Sistema seguro - Control de dispositivos activado</p>
</div>
</div> <!-- cierre de container -->

<!-- Modal para el Chat GPT - FUERA del container principal -->
<div id="gptModal">
    <div class="modal-content">
        <div class="modal-header">
            <div>
                <h3>ü§ñ Asesor Virtual "Vitalidad Total"</h3>
                <p>LifeHuni - Suplementos Dietarios Naturales</p>
            </div>
            <button id="closeModal">√ó</button>
        </div>
        
        <div id="chatContainer">
            <!-- Los mensajes del chat aparecer√°n aqu√≠ -->
            <div class="chat-message bot-message">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <strong>Asesor Virtual "Vitalidad Total"</strong>
                    <p>¬°Hola! Soy tu asesor especializado en suplementos dietarios naturales. ¬øEn qu√© puedo ayudarte hoy?</p>
                    <span class="message-time" id="initialTime"></span>
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <div class="input-container">
                <input type="text" id="userMessage" placeholder="Escribe tu pregunta sobre suplementos...">
                <button id="sendMessage">Enviar</button>
            </div>
            <p class="security-notice">
                üîí Conexi√≥n segura - Sesi√≥n registrada - Tokens en uso: <span id="tokenCounter">0</span>
            </p>
        </div>
    </div>
</div>

<script>
    // Script para el timestamp inicial
    document.getElementById('initialTime').textContent = new Date().toLocaleTimeString('es-CO');
</script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<!-- FingerprintJS Library -->
<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3.4.0/dist/fp.min.js"></script>

<script>
        // =============================================
        // CONFIGURACI√ìN INICIAL Y VARIABLES GLOBALES
        // =============================================
        
        // Configuraci√≥n de Firebase - Lifehuni
        const firebaseConfig = {
            apiKey: "AIzaSyC-jbuu3oq0tOuvmwwgpoPL02oa9dqz0w0",
            authDomain: "experto-asesorvirtual-lifehuni.firebaseapp.com",
            projectId: "experto-asesorvirtual-lifehuni",
            storageBucket: "experto-asesorvirtual-lifehuni.appspot.com",
            messagingSenderId: "885294704059",
            appId: "1:885294704059:web:049cfe61e42b030637509e"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Inicializar servicios
        const auth = firebase.auth();
        const db = firebase.firestore();
// ============================
// CONTROL DEL ESTADO DE SESI√ìN (versi√≥n estable)
// ============================
window.addEventListener('load', () => {
    console.log("üöÄ Verificando sesi√≥n al cargar la p√°gina...");

    auth.onAuthStateChanged(async (user) => {
        try {
            if (user) {
                console.log("‚úÖ Sesi√≥n activa:", user.email);

                const userDoc = await db.collection("users").doc(user.uid).get();

                if (!userDoc.exists) {
                    console.warn("‚ö†Ô∏è Usuario sin documento en Firestore, cerrando sesi√≥n...");
                    await auth.signOut();
                    return;
                }

                const userData = userDoc.data();
                let approvedAt = null;
                if (userData.approvedAt) {
                    approvedAt = userData.approvedAt.toDate
                        ? userData.approvedAt.toDate()
                        : new Date(userData.approvedAt);
                }

                const now = new Date();
                const diffDays = approvedAt
                    ? Math.floor((now - approvedAt) / (1000 * 60 * 60 * 24))
                    : 999;

                if (diffDays >= 30) {
                    console.log("‚ö†Ô∏è Suscripci√≥n vencida");
                    showExpiredSubscriptionScreen(user.email);
                } else {
                    if (typeof loadDashboard === 'function') {
                        loadDashboard(userData);
                    } else {
                        console.warn("‚ö†Ô∏è loadDashboard() no est√° definida.");
                    }

                    if (typeof startRealTimeUpdates === 'function') {
                        startRealTimeUpdates(user.uid);
                    }
                }
            } else {
                console.log("üîí Ninguna sesi√≥n iniciada ‚Äî mostrando pantalla de login");

                // Aqu√≠ NO tocamos el body completo, solo mostramos el login original
                const loginSection = document.getElementById('loginSection');
                const registerSection = document.getElementById('registerSection');
                if (loginSection) loginSection.style.display = 'block';
                if (registerSection) registerSection.style.display = 'none';
            }
        } catch (err) {
            console.error("‚ùå Error en control de sesi√≥n:", err);
        }
    });
});

        // Variable global para el fingerprint
        let deviceFingerprint = null;

        // Sistema de Chat - ‚ö†Ô∏è SOLO UNA DECLARACI√ìN
        let chatSession = {
            messages: [],
            tokenCount: 0,
            sessionId: null,
            startTime: null
        };

        // Elementos del DOM
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const messageDiv = document.getElementById('message');
        const fingerprintStatus = document.getElementById('fingerprintStatus');
        const newDeviceAlert = document.getElementById('newDeviceAlert');
        
        // Botones de carga
        const loginButton = document.getElementById('loginButton');
        const registerButton = document.getElementById('registerButton');
        const loginText = document.getElementById('loginText');
        const registerText = document.getElementById('registerText');
        const loginLoading = document.getElementById('loginLoading');
        const registerLoading = document.getElementById('registerLoading');

        // =============================================
        // FUNCIONALIDADES EXISTENTES (SIN MODIFICAR)
        // =============================================

        // Funcionalidad de toggle entre login y registro
        loginBtn.addEventListener('click', function() {
            this.classList.add('active');
            registerBtn.classList.remove('active');
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
            messageDiv.style.display = 'none';
            newDeviceAlert.style.display = 'none';
        });

        registerBtn.addEventListener('click', function() {
            this.classList.add('active');
            loginBtn.classList.remove('active');
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            messageDiv.style.display = 'none';
            newDeviceAlert.style.display = 'none';
            
            // Resetear estado del fingerprint
            fingerprintStatus.style.display = 'none';
            fingerprintStatus.textContent = 'üîí Detectando dispositivo...';
            fingerprintStatus.style.background = '#e8f5e8';
            fingerprintStatus.style.color = '#2E8B57';
            fingerprintStatus.style.borderColor = '#c3e6cb';
        });

        // Funci√≥n del ojo para ver contrase√±a
        document.querySelectorAll('.password-toggle').forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const passwordInput = document.getElementById(targetId);
                const isPassword = passwordInput.type === 'password';
                
                // Cambiar tipo de input
                passwordInput.type = isPassword ? 'text' : 'password';
                
                // Cambiar icono del ojo
                this.textContent = isPassword ? 'üôà' : 'üëÅÔ∏è';
                
                // Cambiar t√≠tulo (accesibilidad)
                this.title = isPassword ? 'Ocultar contrase√±a' : 'Mostrar contrase√±a';
            });
        });

        // =============================================
        // SISTEMA DE DEVICE FINGERPRINTING (EXISTENTE)
        // =============================================

        // Inicializar FingerprintJS
        async function initializeFingerprint() {
            try {
                fingerprintStatus.textContent = 'üîí Detectando dispositivo...';
                
                // Cargar la librer√≠a de FingerprintJS
                const fp = await FingerprintJS.load();
                
                // Obtener el visitorId (fingerprint)
                const result = await fp.get();
                deviceFingerprint = result.visitorId;

                // Mostrar cuando est√© completo
                fingerprintStatus.style.display = 'block';
                console.log('Fingerprint capturado:', deviceFingerprint);

            } catch (error) {
                console.error('Error capturando fingerprint:', error);
                fingerprintStatus.style.display = 'block';
                fingerprintStatus.textContent = '‚ö†Ô∏è Error en registro de dispositivo';
                fingerprintStatus.style.background = '#fff3cd';
                fingerprintStatus.style.color = '#856404';
                fingerprintStatus.style.borderColor = '#ffeaa7';
            }
        }

        // Obtener fingerprint para login
        async function getFingerprint() {
            try {
                const fp = await FingerprintJS.load();
                const result = await fp.get();
                return result.visitorId;
            } catch (error) {
                console.error('Error obteniendo fingerprint:', error);
                return null;
            }
        }
        
// Despu√©s de la funci√≥n getFingerprint(), agrega:
console.log("üîç DEBUG FINGERPRINT - UserAgent:", navigator.userAgent);
console.log("üîç DEBUG FINGERPRINT - Platform:", navigator.platform);
console.log("üîç DEBUG FINGERPRINT - Languages:", navigator.languages);

        // Funciones para mostrar mensajes
        function showMessage(text, type) {
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
        }

        // Funci√≥n para mostrar carga
        function showLoading(button, text, loading) {
            button.disabled = true;
            text.style.display = 'none';
            loading.style.display = 'inline-block';
        }

        // Funci√≥n para ocultar carga
        function hideLoading(button, text, loading) {
            button.disabled = false;
            text.style.display = 'inline-block';
            loading.style.display = 'none';
        }

        // =============================================
        // SISTEMA DE REGISTRO CON FINGERPRINTING (EXISTENTE)
        // =============================================

        registerForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    console.log("üéØ DEBUG - Bot√≥n de registro presionado");

    // Inicializar fingerprint solo si no se ha generado a√∫n
    if (!deviceFingerprint) {
        console.log("üîÑ DEBUG - Inicializando fingerprint...");
        await initializeFingerprint();
    }
    
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    // ‚úÖ NUEVO: Obtener datos del formulario
    const userName = document.getElementById('registerName').value.trim();
    const userLastName = document.getElementById('registerLastName').value.trim();
    const userPhone = document.getElementById('registerPhone').value.trim();
    const fullName = `${userName} ${userLastName}`.trim();

    console.log("üîç DEBUG - Datos capturados:", {
        email: email,
        userName: userName,
        userLastName: userLastName,
        userPhone: userPhone,
        fullName: fullName
    });

    // Validaciones
    if (password !== confirmPassword) {
        showMessage('Las contrase√±as no coinciden', 'error');
        return;
    }

    if (password.length < 6) {
        showMessage('La contrase√±a debe tener al menos 6 caracteres', 'error');
        return;
    }

    // ‚úÖ NUEVO: Validaciones para los campos nuevos (M√ÅS FLEXIBLES)
    if (!userName || userName.length < 2) {
        showMessage('‚ùå Por favor ingresa tus nombres (m√≠nimo 2 letras)', 'error');
        return;
    }

    if (!userLastName || userLastName.length < 2) {
        showMessage('‚ùå Por favor ingresa tus apellidos (m√≠nimo 2 letras)', 'error');
        return;
    }

    if (!userPhone || userPhone.length < 7) {
        showMessage('‚ùå Por favor ingresa un tel√©fono v√°lido (m√≠nimo 7 d√≠gitos)', 'error');
        return;
    }

    // Verificar que tenemos el fingerprint
    if (!deviceFingerprint) {
        showMessage('Error: No se pudo registrar el dispositivo. Intenta recargar la p√°gina.', 'error');
        return;
    }

    showLoading(registerButton, registerText, registerLoading);
    console.log("üîÑ DEBUG - Iniciando creaci√≥n de usuario...");

    try {
        // Crear usuario en Firebase Authentication
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        console.log("‚úÖ DEBUG - Usuario de auth creado:", user.uid);

        // Obtener timestamp actual
        const currentTimestamp = new Date();

        // Informaci√≥n del dispositivo
        const deviceInfo = {
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            language: navigator.language,
            screenResolution: `${screen.width}x${screen.height}`,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            browser: navigator.userAgent.includes('Chrome') ? 'Chrome' : 
                    navigator.userAgent.includes('Firefox') ? 'Firefox' : 
                    navigator.userAgent.includes('Safari') ? 'Safari' : 'Navegador'
        };

        // Guardar informaci√≥n adicional en Firestore CON FINGERPRINT
        await db.collection('users').doc(user.uid).set({
            email: email,
            name: fullName,           // ‚úÖ NUEVO: Nombre completo
            firstName: userName,      // ‚úÖ NUEVO: Solo nombre
            lastName: userLastName,   // ‚úÖ NUEVO: Solo apellido  
            phone: userPhone,         // ‚úÖ NUEVO: Tel√©fono
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            registerDate: currentTimestamp.toISOString(), // ‚úÖ NUEVO CAMPO
            status: 'pending',
            devices: {
                [deviceFingerprint]: {
                    deviceInfo: deviceInfo,
                    registeredAt: currentTimestamp.toISOString(),
                    isActive: true,
                    lastLogin: currentTimestamp.toISOString()
                }
            },
            currentDevice: deviceFingerprint,
            pendingDevices: {},
            subscription: {
                status: 'active',
                totalTokens: 1000,
                usedTokens: 0,
                remainingTokens: 1000,
                startDate: new Date().toISOString(),
                endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
            }
        });

        console.log("‚úÖ DEBUG - Usuario guardado en Firestore");
        showWelcomeMessage(fullName);
registerForm.reset();
fingerprintStatus.style.display = 'none';

        registerForm.reset();
        fingerprintStatus.style.display = 'none';

    } catch (error) {
        console.error("‚ùå DEBUG - Error completo:", error);
        let errorMessage = 'Error al crear la cuenta: ';
        
        switch (error.code) {
            case 'auth/email-already-in-use':
                errorMessage += 'Este email ya est√° registrado';
                break;
            case 'auth/invalid-email':
                errorMessage += 'Email inv√°lido';
                break;
            case 'auth/weak-password':
                errorMessage += 'La contrase√±a es muy d√©bil';
                break;
            default:
                errorMessage += error.message;
        }
        
        showMessage(errorMessage, 'error');
    } finally {
        hideLoading(registerButton, registerText, registerLoading);
    }
});

        // =============================================
        // SISTEMA DE LOGIN CON VERIFICACI√ìN DE FINGERPRINT (EXISTENTE)
        // =============================================

        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            showLoading(loginButton, loginText, loginLoading);
            newDeviceAlert.style.display = 'none';

            try {
                // 1. Iniciar sesi√≥n con Firebase Auth
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // 2. Obtener fingerprint actual
                const currentFingerprint = await getFingerprint();
                if (!currentFingerprint) {
                    throw new Error('No se pudo verificar el dispositivo');
                }

                // 3. Obtener datos del usuario desde Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (!userDoc.exists) {
                    throw new Error('Usuario no encontrado en la base de datos');
                }

                const userData = userDoc.data();

                // 4. VERIFICAR ESTADO DEL USUARIO
                if (userData.status !== 'approved') {
                    await auth.signOut(); // Cerrar sesi√≥n
                    throw new Error('Cuenta pendiente de aprobaci√≥n por el administrador');
                }

                // 5. VERIFICAR SUSCRIPCI√ìN (NUEVO - TIPO TELEF√ìNICA)
                const subscriptionStatus = await verifySubscriptionStatus(user.uid, userData);
                
                if (subscriptionStatus === 'expired') {
                    // ‚ùå SUSCRIPCI√ìN VENCIDA - MOSTRAR PANTALLA DE RENOVACI√ìN
                    await auth.signOut();
                    showExpiredSubscriptionScreen(email);
                    return;
                }

                // 6. VERIFICAR FINGERPRINT
                const currentTimestamp = new Date().toISOString();
                
                if (userData.devices && userData.devices[currentFingerprint]) {
                    // ‚úÖ DISPOSITIVO AUTORIZADO - Actualizar √∫ltimo login
                    await db.collection('users').doc(user.uid).update({
                        [`devices.${currentFingerprint}.lastLogin`]: currentTimestamp,
                        currentDevice: currentFingerprint
                    });

                    showMessage('‚úÖ Login exitoso! Redirigiendo al Asesor Virtual...', 'success');
                    
                    // Redirigir al dashboard del cliente despu√©s de 2 segundos
                    setTimeout(() => {
                        createClientDashboard(user, userData);
                    }, 2000);

                } else {
    // ‚ùå NUEVO DISPOSITIVO - Bloquear acceso y notificar
    console.log("üö® DETECTADO NUEVO DISPOSITIVO - Iniciando proceso...");
    
    await auth.signOut();

    // Informaci√≥n del nuevo dispositivo
    const newDeviceInfo = {
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        language: navigator.language,
        screenResolution: `${screen.width}x${screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        attemptedLogin: currentTimestamp
    };

    console.log("üì± Informaci√≥n del dispositivo:", newDeviceInfo);

    // Obtener datos del usuario para el admin
    const userData = userDoc.data();
    console.log("üë§ Datos del usuario:", userData);

    try {
        console.log("üîÑ Intentando guardar en pendingDevices...");
        
        // ‚úÖ CORRECCI√ìN: Guardar en la colecci√≥n 'pendingDevices'
        const deviceDocRef = await db.collection('pendingDevices').add({
            userId: user.uid,
            userEmail: user.email,
            userName: userData.name || 'No disponible',
            userPhone: userData.phone || 'No disponible',
            deviceFingerprint: currentFingerprint,
            deviceInfo: newDeviceInfo,
            timestamp: currentTimestamp,
            status: 'pending',
            attemptedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log("‚úÖ √âXITO: Dispositivo guardado en pendingDevices con ID:", deviceDocRef.id);
        console.log("üìä Datos guardados:", {
            userId: user.uid,
            userEmail: user.email,
            deviceFingerprint: currentFingerprint
        });

        // ‚úÖ Tambi√©n mantener en el usuario para referencia interna
        await db.collection('users').doc(user.uid).update({
            [`pendingDevices.${currentFingerprint}`]: {
                deviceInfo: newDeviceInfo,
                attemptedAt: currentTimestamp,
                status: 'pending'
            }
        });

        console.log("‚úÖ Tambi√©n guardado en usuario");

    } catch (error) {
        console.error("‚ùå ERROR guardando dispositivo pendiente:", error);
        console.error("üîß Detalles del error:", error.message, error.code);
        alert("Error t√©cnico: " + error.message); // üëà ESTO TE MOSTRAR√Å EL ERROR EN PANTALLA
    }
    
    // Mostrar alerta al usuario
    newDeviceAlert.style.display = 'block';
    showMessage('‚ùå Dispositivo no autorizado. Se ha notificado al administrador.', 'error');
}

            } catch (error) {
                let errorMessage = 'Error al iniciar sesi√≥n: ';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage += 'Usuario no encontrado';
                        break;
                    case 'auth/wrong-password':
                        errorMessage += 'Contrase√±a incorrecta';
                        break;
                    case 'auth/invalid-email':
                        errorMessage += 'Email inv√°lido';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                showMessage(errorMessage, 'error');
            } finally {
                hideLoading(loginButton, loginText, loginLoading);
            }
        });

        // =============================================
        // SISTEMA DE SUSCRIPCI√ìN - TIPO TELEF√ìNICA (EXISTENTE)
        // =============================================

        async function verifySubscriptionStatus(userUID, userData) {
            try {
                const subscriptionDoc = await db.collection('subscriptions').doc(userUID).get();
                const subscriptionData = subscriptionDoc.exists ? subscriptionDoc.data() : userData.subscription;
                
                if (!subscriptionData) return 'active';
                
                const endDate = new Date(subscriptionData.endDate);
                const today = new Date();
                
                return endDate < today ? 'expired' : subscriptionData.status || 'active';
                
            } catch (error) {
                console.error('Error verificando suscripci√≥n:', error);
                return 'active';
            }
        }

        function showExpiredSubscriptionScreen(email) {
            document.body.innerHTML = `
                <div class="expired-screen">
                    <div class="warning-icon">üö´</div>
                    <h2>Servicio Suspendido</h2>
                    <p>Tu suscripci√≥n Experto Asesor Virtual Lifehuni ha vencido</p>
                    <p><strong>Usuario:</strong> ${email}</p>
                    
                    <div class="renewal-options">
                                             
                        <div class="plan-option recommended">
                            <h3>üü° Plan Premium</h3>
                            <p>100000 tokens - 30 d√≠as</p>
                            <span class="price">$25.000 COP</span>
                            <button class="renew-btn" onclick="contactAdminForRenewal('premium')">Renovar Ahora</button>
                        </div>
            
                    </div>
                    
                    <p class="support-text">¬øProblemas con la renovaci√≥n? <a href="#" onclick="contactSupport()">Contactar soporte</a></p>
                    <button class="logout-btn" onclick="logoutUser()" style="margin-top: 20px;">üö™ Cerrar Sesi√≥n</button>
                </div>
            `;
        }
async function contactAdminForRenewal(plan) {
    const user = firebase.auth().currentUser;

    if (!user) {
        alert("üîí Debes iniciar sesi√≥n nuevamente para enviar tu solicitud de renovaci√≥n.");
        firebase.auth().signOut();
        setTimeout(() => {
            window.location.href = "index.html"; // vuelve a login
        }, 2000);
        return;
    }

    try {
        // Verificar si ya existe una solicitud pendiente
        const existingRequest = await db.collection('renewalRequests')
            .where('userId', '==', user.uid)
            .where('status', '==', 'pending')
            .get();

        if (!existingRequest.empty) {
            alert("üì¨ Ya has enviado una solicitud de renovaci√≥n. Espera la respuesta del administrador.");
            return;
        }

        // Crear nueva solicitud de renovaci√≥n
        await db.collection('renewalRequests').add({
            userId: user.uid,
            userEmail: user.email,
            requestedPlan: 'Premium',
            status: 'pending',
            requestedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert("‚úÖ Solicitud enviada correctamente. Te contactaremos para confirmar el pago y reactivar tu servicio.");
    } catch (error) {
        console.error("Error enviando solicitud:", error);
        alert("‚ùå Ocurri√≥ un error al enviar la solicitud. Intenta nuevamente.");
    }
}
       
       function contactSupport() {
    const user = firebase.auth().currentUser; // obtiene el usuario actual
    const phoneNumber = "573023706402"; // sin el s√≠mbolo +, con el indicativo de pa√≠s

    // Si el usuario est√° autenticado, usamos su correo; si no, dejamos uno gen√©rico
    const email = user ? user.email : "Usuario no identificado";

    const message = encodeURIComponent(
        `¬°Hola! Soy ${email}, necesito ayuda con mi suscripci√≥n Experto Asesor Virtual LifeHuni.`
    );

    const url = `https://wa.me/${phoneNumber}?text=${message}`;

    // Abre WhatsApp en el navegador o en la app del celular
    window.open(url, "_blank");
}

        // =============================================
        // DASHBOARD CLIENTE PREMIUM - VERSI√ìN OPTIMIZADA (EXISTENTE)
        // =============================================

        async function createClientDashboard(user, userData) {
            try {
                console.log('üöÄ Iniciando creaci√≥n del dashboard para:', user.email);
                
                // 1. ‚úÖ VALIDACIONES INICIALES MEJORADAS
                if (!user || !user.uid) {
                    throw new Error('Usuario no autenticado correctamente');
                }

                // 2. ‚úÖ CARGAR DATOS ACTUALIZADOS SI ES NECESARIO
                if (!userData) {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (!userDoc.exists) {
                        throw new Error('Usuario no encontrado en la base de datos');
                    }
                    userData = userDoc.data();
                }

                // 3. ‚úÖ VERIFICAR ESTADO DE SUSCRIPCI√ìN
                const subscriptionStatus = await verifySubscriptionStatus(user.uid, userData);
                
                if (subscriptionStatus === 'expired') {
                    showExpiredSubscriptionScreen(user.email);
                    return;
                }

                // 4. üé® CONSTRUIR Y MOSTRAR DASHBOARD
                await buildAndShowDashboard(user, userData, subscriptionStatus);
                
                // 5. üîÑ INICIAR ACTUALIZACIONES EN TIEMPO REAL
                startRealTimeUpdates(user.uid);

                console.log('‚úÖ Dashboard creado exitosamente');

            } catch (error) {
                console.error('‚ùå Error creando dashboard:', error);
                showDashboardMessage('Error cargando el dashboard: ' + error.message, 'error');
                setTimeout(() => location.reload(), 3000);
            }
        }

        // üé® CONSTRUIR Y MOSTRAR DASHBOARD
        async function buildAndShowDashboard(user, userData, subscriptionStatus) {
            const userEmail = user.email;
            const deviceInfo = getDeviceInfo();
            const subscriptionData = calculateSubscriptionData(userData);
            
            document.body.innerHTML = `
                <div class="dashboard-container">
                    <!-- HEADER MEJORADO -->
                    <header class="dashboard-header">
                        <div class="header-content">
                            <div class="brand-section">
                                <div class="dashboard-logo">
                                    <img src="logo-lifehuni.png" alt="Lifehuni Logo">
                                </div>
                                <div class="brand-text">
                                    <h1>LIFEHUNI</h1>
                                    <span class="premium-badge">PREMIUM</span>
                                </div>
                            </div>
                            <div class="user-section">
                                <div class="user-info-dropdown" id="userDropdown">
                                    <span class="user-avatar">üë§</span>
                                    <span class="user-email">${userEmail}</span>
                                    <span class="dropdown-arrow">‚ñº</span>
                                    <div class="dropdown-content">
                                        <div class="user-stats">
                                            <div class="stat-item">
                                                <span class="stat-label">Dispositivo:</span>
                                                <span class="stat-value">${deviceInfo.type}</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">Navegador:</span>
                                                <span class="stat-value">${deviceInfo.browser}</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">Fecha:</span>
                                                <span class="stat-value">${deviceInfo.date}</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">Hora:</span>
                                                <span class="stat-value" id="liveTime">${deviceInfo.time}</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">Estado:</span>
                                                <span class="status-badge active">‚úÖ Activo</span>
                                            </div>
                                        </div>
                                        <button class="dropdown-btn logout-btn" onclick="window.logoutUser()">
                                            üö™ Cerrar Sesi√≥n
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </header>

                    <!-- CONTENIDO PRINCIPAL OPTIMIZADO -->
                    <main class="dashboard-main">
                        <!-- SECCI√ìN BIENVENIDA -->
                        <section class="welcome-section">
                            <div class="welcome-card">
                                <h2>üéØ Bienvenido al Asesor Virtual Premium</h2>
                                <p>Acceso exclusivo a consultor√≠a especializada en suplementos y nutrici√≥n</p>
                                <div class="welcome-features">
                                    <div class="feature-item">
                                        <span class="feature-icon">üß†</span>
                                        <span>Asesor√≠a 24/7</span>
                                    </div>
                                    <div class="feature-item">
                                        <span class="feature-icon">üíä</span>
                                        <span>Suplementos Personalizados</span>
                                    </div>
                                    <div class="feature-item">
                                        <span class="feature-icon">üìä</span>
                                        <span>Seguimiento Nutricional</span>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- ALERTAS DE SUSCRIPCI√ìN DIN√ÅMICAS -->
                        ${buildSubscriptionAlerts(subscriptionData)}

                        <!-- PANEL DE ACCESO R√ÅPIDO -->
                        <section class="access-panel">
                            <div class="panel-header">
                                <h3>üîó Accesos Directos</h3>
                                <p>Herramientas disponibles para tu consulta</p>
                            </div>
                            
                            <div class="access-grid">
                                <div class="access-card primary" onclick="window.accessGPT()">
                                    <div class="card-icon">ü§ñ</div>
                                    <div class="card-content">
                                        <h4>Asesor Virtual IA</h4>
                                        <p>Consulta especializada en tiempo real</p>
                                        <span class="access-badge">RECOMENDADO</span>
                                    </div>
                                    <div class="card-arrow">‚Üí</div>
                                </div>

                                <div class="access-card" onclick="window.openNutritionPlan()">
                                    <div class="card-icon">üìã</div>
                                    <div class="card-content">
                                        <h4>Plan Nutricional</h4>
                                        <p>Tu plan personalizado de suplementos</p>
                                    </div>
                                    <div class="card-arrow">‚Üí</div>
                                </div>

                                <div class="access-card" onclick="window.openProgressTracker()">
                                    <div class="card-icon">üìà</div>
                                    <div class="card-content">
                                        <h4>Seguimiento</h4>
                                        <p>Monitorea tu progreso</p>
                                    </div>
                                    <div class="card-arrow">‚Üí</div>
                                </div>

                                <div class="access-card" onclick="window.openSupport()">
                                    <div class="card-icon">üí¨</div>
                                    <div class="card-content">
                                        <h4>Soporte Premium</h4>
                                        <p>Ayuda personalizada</p>
                                    </div>
                                    <div class="card-arrow">‚Üí</div>
                                </div>
                            </div>
                        </section>

                        <!-- PANEL DE TOKENS MEJORADO -->
                        <section class="tokens-panel">
                            <div class="panel-header">
                                <h3>üíé Sistema de Tokens Premium</h3>
                                <p id="tokensSubtitle">Gestiona tu consumo y renovaci√≥n</p>
                            </div>
                            
                            <div class="tokens-grid">
                                <div class="token-card primary">
                                    <div class="token-icon">ü™ô</div>
                                    <div class="token-info">
                                        <h3 id="remainingTokens">${subscriptionData.remainingTokens}</h3>
                                        <p>Tokens Disponibles</p>
                                        <div class="token-progress">
                                            <div class="progress-bar">
                                                <div class="progress-fill" id="tokenProgress" style="width: ${subscriptionData.progressPercentage}%"></div>
                                            </div>
                                            <span class="progress-text" id="tokenUsage">${subscriptionData.usedTokens}/${subscriptionData.totalTokens} usados</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="token-card">
                                    <div class="token-icon">‚è≥</div>
                                    <div class="token-info">
                                        <h3 id="daysUntilRenewal" class="${subscriptionData.daysUntilRenewal <= 7 ? 'warning-text' : ''}">${subscriptionData.daysUntilRenewal}</h3>
                                        <p>D√≠as para renovaci√≥n</p>
                                        <small id="renewalDate">Vence: ${subscriptionData.endDateFormatted}</small>
                                    </div>
                                </div>
                                
                                <div class="token-card">
                                    <div class="token-icon">üìä</div>
                                    <div class="token-info">
                                        <h3 id="dailyAverage">${Math.round(subscriptionData.usedTokens/30)}</h3>
                                        <p>Promedio diario</p>
                                        <small>√öltimos 30 d√≠as</small>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- ESTAD√çSTICAS R√ÅPIDAS -->
                        <section class="stats-section">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-icon">üìÖ</div>
                                    <div class="stat-info">
                                        <h3 id="currentDay">${deviceInfo.day}</h3>
                                        <p>D√≠a Actual</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">‚è±Ô∏è</div>
                                    <div class="stat-info">
                                        <h3 id="currentTime">${deviceInfo.time}</h3>
                                        <p>Hora Actual</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon">‚úÖ</div>
                                    <div class="stat-info">
                                        <h3>Premium</h3>
                                        <p>Estado Cuenta</p>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- NOTIFICACIONES DIN√ÅMICAS -->
                        <section class="notifications-section">
                            <div class="notification-card">
                                <div class="notification-header">
                                    <h3>üîî Notificaciones</h3>
                                    <span class="notification-badge" id="notificationCount">1</span>
                                </div>
                                <div class="notification-list" id="notificationList">
                                    <div class="notification-item new">
                                        <div class="notification-icon">üéâ</div>
                                        <div class="notification-content">
                                            <p><strong>¬°Bienvenido a Lifehuni Premium!</strong></p>
                                            <p>Tu cuenta ha sido activada exitosamente</p>
                                            <span class="notification-time">${deviceInfo.date} - ${deviceInfo.time}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </main>

                    <!-- FOOTER -->
                    <footer class="dashboard-footer">
                        <p>üîí Sistema seguro - Lifehuni Experto Asesor Virtual ¬© 2025</p>
                    </footer>
                </div>
            `;

            // INICIALIZAR COMPONENTES INTERACTIVOS
            initializeDashboardInteractivity();
        }

        // üì± OBTENER INFORMACI√ìN DEL DISPOSITIVO
        function getDeviceInfo() {
            const now = new Date();
            const deviceType = navigator.userAgent.includes('Mobile') ? 'üì± M√≥vil' : 'üíª Escritorio';
            const browser = navigator.userAgent.includes('Chrome') ? 'Chrome' : 
                           navigator.userAgent.includes('Firefox') ? 'Firefox' : 
                           navigator.userAgent.includes('Safari') ? 'Safari' : 'Navegador';
            
            return {
                type: deviceType,
                browser: browser,
                date: now.toLocaleDateString('es-CO'),
                time: now.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' }),
                day: now.getDate()
            };
        }

        // üìä CALCULAR DATOS DE SUSCRIPCI√ìN
        function calculateSubscriptionData(userData) {
            const subscription = userData.subscription || {
                status: 'active',
                endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                totalTokens: 1000,
                usedTokens: 275
            };

            const endDate = new Date(subscription.endDate);
            const now = new Date();
            const daysUntilRenewal = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
            const totalTokens = subscription.totalTokens || 1000;
            const usedTokens = subscription.usedTokens || 275;
            const remainingTokens = totalTokens - usedTokens;

            return {
                daysUntilRenewal,
                totalTokens,
                usedTokens,
                remainingTokens,
                endDate,
                endDateFormatted: endDate.toLocaleDateString('es-CO'),
                progressPercentage: (usedTokens / totalTokens) * 100
            };
        }

        // üîî CONSTRUIR ALERTAS DE SUSCRIPCI√ìN
        function buildSubscriptionAlerts(subscriptionData) {
            const { daysUntilRenewal } = subscriptionData;
            
            if (daysUntilRenewal > 7) return '';
            
            let alertType = 'normal';
            let alertMessage = '';
            let alertIcon = '‚úÖ';

            if (daysUntilRenewal <= 1) {
                alertType = 'urgent';
                alertMessage = 'üö® ¬°URGENTE! Tu suscripci√≥n vence MA√ëANA';
                alertIcon = 'üö®';
            } else if (daysUntilRenewal <= 3) {
                alertType = 'warning';
                alertMessage = `üîî ¬°ATENCI√ìN! Tu suscripci√≥n vence en ${daysUntilRenewal} d√≠as`;
                alertIcon = 'üîî';
            } else if (daysUntilRenewal <= 5) {
                alertType = 'alert';
                alertMessage = `‚ö†Ô∏è Tu suscripci√≥n vence en ${daysUntilRenewal} d√≠as`;
                alertIcon = '‚ö†Ô∏è';
            }

            return `
                <section class="subscription-section">
                    <div class="subscription-alert ${alertType}">
                        <div class="alert-icon">${alertIcon}</div>
                        <div class="alert-content">
                            <h4>${alertMessage.split('!')[0]}!</h4>
                            <p>${alertMessage.split('!')[1]}</p>
                            <button class="renew-btn" onclick="window.handleRenewal()">
                                Renovar Ahora
                            </button>
                        </div>
                    </div>
                </section>
            `;
        }

        // üîß INICIALIZAR INTERACTIVIDAD DEL DASHBOARD
        function initializeDashboardInteractivity() {
            // Dropdown de usuario
            const userDropdown = document.getElementById('userDropdown');
            if (userDropdown) {
                userDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const dropdown = this.querySelector('.dropdown-content');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                });
            }

            // Cerrar dropdown al hacer click fuera
            document.addEventListener('click', function() {
                const dropdowns = document.querySelectorAll('.dropdown-content');
                dropdowns.forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
            });

            // Actualizar hora en tiempo real
            setInterval(updateLiveTime, 60000);
            
            console.log('‚úÖ Interactividad del dashboard inicializada');
        }

        // ‚è∞ ACTUALIZAR HORA EN VIVO
        function updateLiveTime() {
            const timeElements = document.querySelectorAll('#liveTime, #currentTime');
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });
            
            timeElements.forEach(element => {
                if (element) element.textContent = timeString;
            });
        }

        // üîÑ ACTUALIZAR DASHBOARD CON DATOS EN TIEMPO REAL
        function updateDashboardWithRealTimeData(userData) {
            // Actualizar tokens si existen
            if (userData.subscription) {
                const tokensElement = document.getElementById('remainingTokens');
                const daysElement = document.getElementById('daysUntilRenewal');
                const progressElement = document.getElementById('tokenProgress');
                const usageElement = document.getElementById('tokenUsage');
                
                if (tokensElement) {
                    const remaining = userData.subscription.totalTokens - userData.subscription.usedTokens;
                    tokensElement.textContent = remaining;
                }
                
                if (daysElement && userData.subscription.endDate) {
                    const endDate = new Date(userData.subscription.endDate);
                    const today = new Date();
                    const daysUntilRenewal = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                    daysElement.textContent = daysUntilRenewal;
                    
                    // Actualizar clases de advertencia
                    if (daysUntilRenewal <= 7) {
                        daysElement.classList.add('warning-text');
                    } else {
                        daysElement.classList.remove('warning-text');
                    }
                }
                
                if (progressElement && usageElement) {
                    const progress = (userData.subscription.usedTokens / userData.subscription.totalTokens) * 100;
                    progressElement.style.width = progress + '%';
                    usageElement.textContent = `${userData.subscription.usedTokens}/${userData.subscription.totalTokens} usados`;
                }
            }
        }

        // üîÑ MANEJAR RENOVACI√ìN DE SUSCRIPCI√ìN
        async function handleRenewal() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    showDashboardMessage('‚ùå No hay usuario autenticado', 'error');
                    return;
                }

                showDashboardMessage('üîÑ Enviando solicitud de renovaci√≥n...', 'warning');

                // Obtener datos actualizados del usuario
                const userDoc = await db.collection('users').doc(user.uid).get();
                const userData = userDoc.data();
                
                // Calcular d√≠as hasta vencimiento
                let daysUntilExpiration = 0;
                if (userData.approvedAt) {
                    const approvedDate = userData.approvedAt.toDate();
                    const expirationDate = new Date(approvedDate);
                    expirationDate.setDate(expirationDate.getDate() + 30);
                    const today = new Date();
                    daysUntilExpiration = Math.ceil((expirationDate - today) / (1000 * 60 * 60 * 24));
                }

                // Crear solicitud de renovaci√≥n en Firestore
                await db.collection('renewalRequests').add({
                    userId: user.uid,
                    userEmail: user.email,
                    requestedPlan: 'Premium',
                    status: 'pending',
                    requestedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    daysUntilExpiration: daysUntilExpiration,
                    currentEndDate: userData.approvedAt ? 
                        new Date(userData.approvedAt.toDate().getTime() + 30 * 24 * 60 * 60 * 1000).toISOString() : 
                        new Date().toISOString()
                });

                showDashboardMessage('‚úÖ Solicitud enviada. Te contactaremos para confirmar el pago.', 'success');
                
                // Log para debugging
                console.log('Solicitud de renovaci√≥n creada para:', user.email);
                
            } catch (error) {
                console.error('Error enviando solicitud:', error);
                showDashboardMessage('‚ùå Error enviando solicitud: ' + error.message, 'error');
            }
        }

        // =============================================
        // üÜï SISTEMA DE CHAT GPT MEJORADO Y SEGURO
        // =============================================

        // Funci√≥n mejorada para acceder al GPT - AHORA EN WINDOW
        window.accessGPT = async function() {
            if (confirm('¬øEst√°s seguro de que quieres acceder al Asesor Virtual IA?\n\nüîí Esta acci√≥n consumir√° tokens de tu suscripci√≥n y registrar√° tu acceso.')) {
                const user = auth.currentUser;
                
                if (!user) {
                    showDashboardMessage('‚ùå Debes iniciar sesi√≥n para usar el Asesor Virtual', 'error');
                    return;
                }

                // Verificar tokens disponibles
                const userDoc = await db.collection('users').doc(user.uid).get();
                const userData = userDoc.data();
                
                if (userData.subscription && userData.subscription.remainingTokens <= 0) {
                    showDashboardMessage('‚ùå No tienes tokens disponibles. Renueva tu suscripci√≥n.', 'error');
                    return;
                }

                // Registrar acceso en Firestore
                await db.collection('user_activity').add({
                    userId: user.uid,
                    action: 'gpt_access_initiated',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    deviceInfo: getDeviceInfo()
                });

                // Iniciar sesi√≥n de chat
                chatSession.sessionId = generateSessionId();
                chatSession.messages = [];
                chatSession.tokenCount = 0;
                chatSession.startTime = Date.now();

                // Mostrar modal de chat
                showChatModal();
                
                showDashboardMessage('‚úÖ Asesor Virtual "Vitalidad Total" iniciado', 'success');
            }
        }

        // Mostrar modal de chat - VERSI√ìN CORREGIDA
        // Mostrar modal de chat - VERSI√ìN MEJORADA Y CORREGIDA
function showChatModal() {
    console.log("üîß Iniciando showChatModal...");
    
    // CREAR EL MODAL DIN√ÅMICAMENTE SI NO EXISTE
    let modal = document.getElementById('gptModal');
    
    if (!modal) {
        console.log("üîÑ Creando modal din√°micamente...");
        modal = document.createElement('div');
        modal.id = 'gptModal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h3>ü§ñ Asesor Virtual "Vitalidad Total"</h3>
                        <p>LifeHuni - Suplementos Dietarios Naturales</p>
                    </div>
                    <button id="closeModal">√ó</button>
                </div>
                
                <div id="chatContainer">
                    <div class="chat-message bot-message">
                        <div class="message-avatar">ü§ñ</div>
                        <div class="message-content">
                            <strong>Asesor Virtual "Vitalidad Total"</strong>
                            <p>¬°Hola! Soy tu asesor especializado en suplementos dietarios naturales. ¬øEn qu√© puedo ayudarte hoy?</p>
                            <span class="message-time" id="initialTime">${new Date().toLocaleTimeString('es-CO')}</span>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <div class="input-container">
                        <input type="text" id="userMessage" placeholder="Escribe tu pregunta sobre suplementos...">
                        <button id="sendMessage">Enviar</button>
                    </div>
                    <p class="security-notice">
                        üîí Conexi√≥n segura - Sesi√≥n registrada - Tokens en uso: <span id="tokenCounter">0</span>
                    </p>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    const chatContainer = document.getElementById('chatContainer');
    
    if (!chatContainer) {
        console.error("‚ùå ERROR: No se puede crear el contenedor del chat");
        alert("Error cr√≠tico: No se puede inicializar el chat.");
        return;
    }
    
    console.log("‚úÖ Modal listo, configurando chat...");
    
    // Limpiar chat anterior (manteniendo solo el mensaje inicial)
    chatContainer.innerHTML = `
        <div class="chat-message bot-message">
            <div class="message-avatar">ü§ñ</div>
            <div class="message-content">
                <strong>Asesor Virtual "Vitalidad Total"</strong>
                <p>¬°Hola! Soy tu asesor especializado en suplementos dietarios naturales. ¬øEn qu√© puedo ayudarte hoy?</p>
                <span class="message-time">${new Date().toLocaleTimeString('es-CO')}</span>
            </div>
        </div>
    `;
    
    // Mostrar modal
    modal.style.display = 'block';
    console.log("‚úÖ Modal mostrado correctamente");
    
    // Configurar event listeners
    const closeBtn = document.getElementById('closeModal');
    const sendBtn = document.getElementById('sendMessage');
    const userInput = document.getElementById('userMessage');
    
    if (closeBtn) {
        closeBtn.onclick = closeChatModal;
        console.log("‚úÖ Bot√≥n cerrar configurado");
    }
    
    if (sendBtn && userInput) {
        sendBtn.onclick = sendChatMessage;
        userInput.onkeypress = function(e) {
            if (e.key === 'Enter') sendChatMessage();
        };
        console.log("‚úÖ Botones de chat configurados");
    }

    // Actualizar contador de tokens
    updateTokenCounter();
    
    // Enfocar el input autom√°ticamente
    setTimeout(() => {
        if (userInput) userInput.focus();
    }, 300);
}

        /// Cerrar modal de chat - VERSI√ìN MEJORADA
function closeChatModal() {
    const modal = document.getElementById('gptModal');
    if (modal) {
        modal.style.display = 'none';
    }
    
    // Registrar cierre de sesi√≥n
    if (auth.currentUser && chatSession.sessionId) {
        db.collection('chat_sessions').doc(chatSession.sessionId).set({
            userId: auth.currentUser.uid,
            messages: chatSession.messages,
            tokenCount: chatSession.tokenCount,
            endedAt: firebase.firestore.FieldValue.serverTimestamp(),
            duration: Math.floor((Date.now() - chatSession.startTime) / 1000)
        }).catch(error => {
            console.error("Error guardando sesi√≥n:", error);
        });
    }
}

        // Enviar mensaje al chat
        async function sendChatMessage() {
            const userInput = document.getElementById('userMessage');
            const message = userInput.value.trim();
            
            if (!message) return;
            
            const user = auth.currentUser;
            if (!user) {
                showChatMessage('‚ùå Error: Sesi√≥n no v√°lida', 'error');
                return;
            }

            // Verificar tokens
            const userDoc = await db.collection('users').doc(user.uid).get();
            const userData = userDoc.data();
            
            if (userData.subscription && userData.subscription.remainingTokens <= 0) {
                showChatMessage('‚ùå No tienes tokens disponibles. Renueva tu suscripci√≥n para continuar.', 'error');
                return;
            }

            // Mostrar mensaje del usuario
            addUserMessage(message);
            userInput.value = '';
            
            // Mostrar indicador de typing
            showTypingIndicator();
            
            try {
                // Enviar mensaje a trav√©s del proxy
                const response = await sendToGPTProxy(message, user.uid);
                
                // Remover indicador de typing
                removeTypingIndicator();
                
                // Mostrar respuesta
                addBotMessage(response);
                
                // Actualizar contador de tokens
                await updateTokenUsage(user.uid, estimateTokenCount(message + response));
                updateTokenCounter();
                
            } catch (error) {
                removeTypingIndicator();
                showChatMessage('‚ùå Error al conectar con el asesor virtual. Intenta nuevamente.', 'error');
                console.error('Error en chat:', error);
            }
        }

        // ‚úÖ FUNCI√ìN MEJORADA QUE CONECTA CON TU GPT REAL
async function sendToGPTProxy(message, userId) {
    console.log("üîó Conectando con Vitalidad Total GPT...");
    
    try {
        // Mostrar indicador "escribiendo..."
        showTypingIndicator();
        
        // üéØ ESTA ES LA CONEXI√ìN SEGURA CON TU GPT
        const response = await fetch('/.netlify/functions/chat-proxy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                userId: userId,
                timestamp: new Date().toISOString()
            })
        });

        if (!response.ok) {
            throw new Error('Error en el servidor');
        }

        const data = await response.json();
        
        // Quitar indicador "escribiendo..."
        removeTypingIndicator();
        
        console.log("‚úÖ Respuesta recibida de GPT personalizado");
        return data.response;
        
    } catch (error) {
        console.error('‚ùå Error conectando con GPT:', error);
        removeTypingIndicator();
        
        // Respuesta si hay error
        return `**Asesor Virtual LifeHuni**\n\nEstoy teniendo dificultades t√©cnicas moment√°neas. Mientras se soluciona, puedo informarte sobre:\n\n‚Ä¢ **Maca-Life** - Energ√≠a y equilibrio hormonal\n‚Ä¢ **Prote√≠nas vegetales** - Recuperaci√≥n muscular\n‚Ä¢ **Vitaminas y minerales** - Salud integral\n\nPor favor, intenta nuevamente en unos minutos.`;
    }
}

        // Funciones auxiliares del chat
        function addUserMessage(message) {
            const chatContainer = document.getElementById('chatContainer');
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message user-message';
            messageElement.innerHTML = `
                <div class="message-content">
                    <p>${escapeHtml(message)}</p>
                    <span class="message-time">${new Date().toLocaleTimeString('es-CO')}</span>
                </div>
                <div class="message-avatar">üë§</div>
            `;
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Guardar en sesi√≥n
            chatSession.messages.push({
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            });
        }

        function addBotMessage(message) {
            const chatContainer = document.getElementById('chatContainer');
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message bot-message';
            messageElement.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <strong>Asesor Virtual "Vitalidad Total"</strong>
                    <p>${escapeHtml(message)}</p>
                    <span class="message-time">${new Date().toLocaleTimeString('es-CO')}</span>
                </div>
            `;
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Guardar en sesi√≥n
            chatSession.messages.push({
                role: 'assistant',
                content: message,
                timestamp: new Date().toISOString()
            });
        }

        function showChatMessage(message, type) {
            const chatContainer = document.getElementById('chatContainer');
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message system-message ${type}`;
            messageElement.innerHTML = `
                <div class="message-content" style="background: ${type === 'error' ? '#f8d7da' : '#fff3cd'}; color: ${type === 'error' ? '#721c24' : '#856404'}">
                    <p>${escapeHtml(message)}</p>
                    <span class="message-time">${new Date().toLocaleTimeString('es-CO')}</span>
                </div>
            `;
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const chatContainer = document.getElementById('chatContainer');
            const typingElement = document.createElement('div');
            typingElement.id = 'typingIndicator';
            typingElement.className = 'chat-message bot-message typing';
            typingElement.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(typingElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingElement = document.getElementById('typingIndicator');
            if (typingElement) {
                typingElement.remove();
            }
        }

        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function estimateTokenCount(text) {
            // Estimaci√≥n simple: ~4 caracteres por token
            const tokens = Math.ceil(text.length / 4);
            chatSession.tokenCount += tokens;
            return tokens;
        }

        async function updateTokenUsage(userId, tokensUsed) {
            const userRef = db.collection('users').doc(userId);
            
            await db.runTransaction(async (transaction) => {
                const userDoc = await transaction.get(userRef);
                if (!userDoc.exists) return;
                
                const userData = userDoc.data();
                const currentUsed = userData.subscription?.usedTokens || 0;
                
                transaction.update(userRef, {
                    'subscription.usedTokens': currentUsed + tokensUsed,
                    'subscription.remainingTokens': userData.subscription.totalTokens - (currentUsed + tokensUsed),
                    'lastActivity': firebase.firestore.FieldValue.serverTimestamp()
                });
            });
        }

        function updateTokenCounter() {
            const tokenCounter = document.getElementById('tokenCounter');
            if (tokenCounter) {
                tokenCounter.textContent = chatSession.tokenCount;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // =============================================
        // FUNCIONES AUXILIARES EXISTENTES - AHORA EN WINDOW
        // =============================================

        // FUNCI√ìN MEJORADA DE CERRAR SESI√ìN
        window.logoutUser = function() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?\n\nSer√°s redirigido al formulario de login.')) {
                // Limpiar recursos del dashboard
                cleanupDashboard();
                
                // Mostrar mensaje de espera
                const logoutMessage = document.createElement('div');
                logoutMessage.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #2E8B57;
                    color: white;
                    padding: 20px 30px;
                    border-radius: 10px;
                    z-index: 10000;
                    font-weight: bold;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                `;
                logoutMessage.innerHTML = 'üîí Cerrando sesi√≥n...';
                document.body.appendChild(logoutMessage);

                auth.signOut().then(() => {
                    logoutMessage.innerHTML = '‚úÖ Sesi√≥n cerrada exitosamente';
                    logoutMessage.style.background = '#28a745';
                    
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                }).catch(error => {
                    logoutMessage.innerHTML = '‚ùå Error al cerrar sesi√≥n';
                    logoutMessage.style.background = '#dc3545';
                    setTimeout(() => {
                        logoutMessage.remove();
                    }, 3000);
                });
            }
        }

        // Funciones auxiliares para el dashboard - AHORA EN WINDOW
        window.openNutritionPlan = function() {
            showDashboardMessage('üîß Funci√≥n en desarrollo - Plan Nutricional pr√≥ximamente', 'warning');
        }

        window.openProgressTracker = function() {
            showDashboardMessage('üîß Funci√≥n en desarrollo - Seguimiento pr√≥ximamente', 'warning');
        }

        window.openSupport = function() {
            showDashboardMessage('üîß Funci√≥n en desarrollo - Soporte pr√≥ximamente', 'warning');
        }

        window.handleRenewal = handleRenewal;

        // Funci√≥n para mostrar mensajes en el dashboard
        function showDashboardMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;

            if (type === 'warning') {
                messageDiv.style.background = '#ffc107';
                messageDiv.style.color = '#000';
            } else if (type === 'error') {
                messageDiv.style.background = '#dc3545';
            } else {
                messageDiv.style.background = '#28a745';
            }

            document.body.appendChild(messageDiv);

            // Auto-remover despu√©s de 5 segundos
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Agregar cleanup cuando el usuario cierre sesi√≥n
        window.addEventListener('beforeunload', cleanupDashboard);

        // =============================================
        // SISTEMA DE NOTIFICACIONES EN TIEMPO REAL
        // =============================================

        // Escuchar notificaciones del usuario - VERSI√ìN TEMPORAL
        function startNotificationListener(userUID) {
            console.log("üîï Notificaciones desactivadas temporalmente");
            // C√≥digo temporalmente desactivado para evitar errores de Firebase
        }

        // Mostrar notificaci√≥n al usuario
        function showUserNotification(notification) {
            const notificationDiv = document.createElement('div');
            notificationDiv.className = 'user-notification';
            notificationDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                max-width: 300px;
                animation: slideInRight 0.3s ease;
                border-left: 4px solid #155724;
            `;

            notificationDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 20px;">‚úÖ</div>
                    <div>
                        <strong>${notification.title}</strong>
                        <div style="font-size: 12px; margin-top: 5px;">${notification.message}</div>
                    </div>
                </div>
            `;

            document.body.appendChild(notificationDiv);

            // Auto-remover despu√©s de 8 segundos
            setTimeout(() => {
                if (notificationDiv.parentElement) {
                    notificationDiv.remove();
                }
            }, 8000);
        }

        // Marcar notificaci√≥n como le√≠da
        async function markNotificationAsRead(notificationId) {
            try {
                await db.collection('user_notifications').doc(notificationId).update({
                    read: true,
                    readAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error marcando notificaci√≥n como le√≠da:', error);
            }
        }

        // üîÑ INICIAR ACTUALIZACIONES EN TIEMPO REAL - VERSI√ìN MEJORADA
        function startRealTimeUpdates(userUID) {
    // Suscribirse a cambios en el documento de usuario
    const userUnsubscribe = db.collection('users').doc(userUID)
        .onSnapshot((doc) => {
            if (doc.exists) {
                const userData = doc.data();
                updateDashboardWithRealTimeData(userData);

                // Si ya hay un listener de renovaciones, lo removemos para evitar duplicados
                if (window.renewalUnsubscribe) {
                    try { window.renewalUnsubscribe(); } catch(e) { /* ignore */ }
                    window.renewalUnsubscribe = null;
                }

                // Crear un listener en tiempo real para la √∫ltima solicitud de renovaci√≥n de este usuario
                if (userData && userData.email) {
                    window.renewalUnsubscribe = db.collection("renewalRequests")
                        .where("userEmail", "==", userData.email)
                        .orderBy("requestedAt", "desc")
                        .limit(1)
                        .onSnapshot((snapshot) => {
                            if (snapshot.empty) return;
                            const doc = snapshot.docs[0];
                            const request = doc.data();
                            const status = request.status;

                            if (status === "approved") {
                                showDashboardMessage("üéâ Tu renovaci√≥n ha sido aprobada. El acceso ha sido reactivado.", "success");
                            } else if (status === "rejected") {
                                showDashboardMessage("‚ùå Tu renovaci√≥n fue rechazada. Contacta soporte para m√°s informaci√≥n.", "error");
                            } else if (status === "pending") {
                                showDashboardMessage("‚åõ Tu solicitud de renovaci√≥n est√° pendiente de revisi√≥n por el administrador.", "info");
                            }
                        }, (err) => {
                            console.error("Error escuchando renovaciones:", err);
                        });
                }
            }
        }, (error) => {
            console.error('Error en actualizaci√≥n en tiempo real:', error);
        });

    // Guardar referencia para limpiar despu√©s
    window.dashboardUnsubscribe = userUnsubscribe;
}

        // üßπ LIMPIAR RECURSOS AL SALIR - VERSI√ìN MEJORADA
        function cleanupDashboard() {
            if (window.dashboardUnsubscribe) {
                window.dashboardUnsubscribe();
            }
            if (window.notificationsUnsubscribe) {
                window.notificationsUnsubscribe();
            }
        }

        console.log("‚úÖ SISTEMA LIFEHUNI COMPLETO - Dashboard Cliente Premium con Chat GPT Integrado");
</script>
<!-- Modal para el Chat GPT - AGREGAR AL DASHBOARD -->
<div id="gptModal">
    <div class="modal-content">
        <div class="modal-header">
            <div>
                <h3>ü§ñ Asesor Virtual "Vitalidad Total"</h3>
                <p>LifeHuni - Suplementos Dietarios Naturales</p>
            </div>
            <button id="closeModal">√ó</button>
        </div>
        
        <div id="chatContainer">
            <!-- Los mensajes del chat aparecer√°n aqu√≠ -->
            <div class="chat-message bot-message">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <strong>Asesor Virtual "Vitalidad Total"</strong>
                    <p>¬°Hola! Soy tu asesor especializado en suplementos dietarios naturales. ¬øEn qu√© puedo ayudarte hoy?</p>
                    <span class="message-time" id="initialTime"></span>
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <div class="input-container">
                <input type="text" id="userMessage" placeholder="Escribe tu pregunta sobre suplementos...">
                <button id="sendMessage">Enviar</button>
            </div>
            <p class="security-notice">
                üîí Conexi√≥n segura - Sesi√≥n registrada - Tokens en uso: <span id="tokenCounter">0</span>
            </p>
        </div>
    </div>
</div>

<script>
    // Script para el timestamp inicial
    document.getElementById('initialTime').textContent = new Date().toLocaleTimeString('es-CO');
    
</script>
<script>
function showWelcomeMessage(fullName) {
  const messageHTML = `
    <div style="font-family: Arial, sans-serif; text-align: center; color: #333; padding: 20px;">
      <h2 style="color:#2E8B57;">¬°Bienvenido(a) a Experto Asesor Virtual Lifehuni!</h2>
      <p style="font-size:16px; line-height:1.5;">
        Hemos recibido tu registro y actualmente se encuentra en proceso de revisi√≥n.<br>
        Te avisaremos por correo cuando tu cuenta sea aprobada y activada.
      </p>
      <button onclick="switchToLogin()" 
        style="margin-top:15px; background:#2E8B57; color:#fff; border:none; padding:10px 16px; 
               border-radius:8px; cursor:pointer; font-size:15px;">
        Ir al inicio de sesi√≥n
      </button>
    </div>
  `;

  const msg = document.getElementById('message');
  msg.innerHTML = messageHTML;
  msg.className = 'message success';
  msg.style.display = 'block';
  document.getElementById('registerForm').style.display = 'none';
}

// Cambia a la pesta√±a de login (si ya existe el bot√≥n en tu c√≥digo)
function switchToLogin() {
  document.getElementById('loginBtn').classList.add('active');
  document.getElementById('registerBtn').classList.remove('active');
  document.getElementById('loginForm').style.display = 'block';
  document.getElementById('registerForm').style.display = 'none';
}

</script>
<script>
// üí° Recuperar contrase√±a usando Firebase Auth
document.getElementById("forgotPasswordLink").addEventListener("click", function (e) {
  e.preventDefault();

  const email = prompt("Por favor, ingresa tu correo electr√≥nico registrado para restablecer tu contrase√±a:");
  if (!email) return;

  firebase.auth().sendPasswordResetEmail(email)
    .then(() => {
      alert("üì© Te enviamos un enlace para restablecer tu contrase√±a. Si no lo encuentras pronto, revisa tambi√©n las carpetas: Spam, No deseado o Promociones ‚Äî a veces llega all√≠ por error. üåø", "success.");
    })
    .catch((error) => {
      console.error(error);
      if (error.code === "auth/user-not-found") {
        alert("‚ö†Ô∏è No existe una cuenta registrada con ese correo.");
      } else if (error.code === "auth/invalid-email") {
        alert("‚ö†Ô∏è Correo electr√≥nico no v√°lido.");
      } else {
        alert("‚ùå Ocurri√≥ un error al intentar enviar el correo. Int√©ntalo nuevamente.");
      }
    });
});
</script>

<script>
// üåø Funci√≥n para mostrar notificaciones flotantes
function showToast(message, type = "success") {
  const container = document.getElementById("toastContainer");
  const toast = document.createElement("div");
  toast.classList.add("toast");

  if (type === "success") {
    toast.style.backgroundColor = "#d4edda";
    toast.style.color = "#155724";
    toast.style.borderColor = "#c3e6cb";
    toast.innerHTML = `<span class="icon">üì©</span> ${message}`;
  } else if (type === "error") {
    toast.style.backgroundColor = "#f8d7da";
    toast.style.color = "#721c24";
    toast.style.borderColor = "#f5c6cb";
    toast.innerHTML = `<span class="icon">‚ö†Ô∏è</span> ${message}`;
  }

  container.appendChild(toast);
  setTimeout(() => {
    toast.remove();
  }, 5000);
}
</script>

</body>
</html>