<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Lifehuni</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a3c5c 0%, #2c5530 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .admin-header {
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .admin-header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .admin-header .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .logout-btn {
            position: absolute;
            right: 20px;
            top: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: white;
            color: #2E8B57;
        }

        /* ========== ESTILOS MEJORADOS PARA GLOBOS INTERACTIVOS ========== */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
            background: #f8f9fa;
        }

        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        @media (min-width: 1200px) {
            .stats-container {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        .stat-card {
            background: white;
            padding: 25px 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #2E8B57;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-card:active {
            transform: translateY(-2px);
        }

        .stat-card.pending {
            border-left-color: #ffc107;
        }

        .stat-card.rejected {
            border-left-color: #dc3545;
        }

        .stat-card.devices {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%);
            animation: pulse-alert 2s infinite;
        }

        .stat-card.renewals {
            border-left-color: #17a2b8;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .stat-icon {
            font-size: 32px;
            margin-bottom: 10px;
            display: block;
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #2E8B57;
            margin-bottom: 5px;
        }

        .stat-card.pending .stat-number {
            color: #ffc107;
        }

        .stat-card.rejected .stat-number {
            color: #dc3545;
        }

        .stat-card.devices .stat-number {
            color: #dc3545;
        }

        .stat-card.renewals .stat-number {
            color: #17a2b8;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            font-weight: 600;
        }

        .stat-card.devices .stat-label {
            color: #dc3545;
            font-weight: 700;
        }

        .stat-card.renewals .stat-label {
            color: #17a2b8;
            font-weight: 700;
        }

        .click-hint {
            font-size: 10px;
            color: #999;
            margin-top: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover .click-hint {
            opacity: 1;
        }

        @keyframes pulse-alert {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* ========== NUEVA SECCI√ìN PR√ìXIMOS A VENCER ========== */
        .expiring-section {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            margin: 20px;
            padding: 20px;
            border-radius: 10px;
            display: none;
        }

        .expiring-section.active {
            display: block;
        }

        .expiring-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffeaa7;
        }

        .expiring-header h3 {
            color: #856404;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .expiring-list {
            display: grid;
            gap: 10px;
        }

        .expiring-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .expiring-user-info {
            flex: 1;
            min-width: 200px;
        }

        .expiring-user-email {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .expiring-details {
            font-size: 12px;
            color: #666;
        }

        .expiring-actions {
            display: flex;
            gap: 10px;
        }

        .btn-reminder {
            background: #ffc107;
            color: black;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .btn-reminder:hover {
            background: #e0a800;
        }

        /* ========== ESTILOS RESPONSIVE MEJORADOS ========== */
        .tab-container {
            background: #f8f9fa;
            border-bottom: 2px solid #e1e5e9;
            overflow-x: auto;
        }

        .tabs {
            display: flex;
            padding: 0 20px;
            min-width: max-content;
        }

        .tab {
            padding: 15px 25px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab.active {
            color: #2E8B57;
            border-bottom-color: #2E8B57;
            background: white;
        }

        .tab:hover {
            color: #2E8B57;
            background: rgba(46, 139, 87, 0.1);
        }

        .content-section {
            display: none;
            padding: 20px;
        }

        .content-section.active {
            display: block;
        }

        .controls-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
            flex-wrap: wrap;
            gap: 15px;
        }

        .controls-left {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .controls-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-box {
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            width: 250px;
            transition: border-color 0.3s ease;
        }

        @media (max-width: 768px) {
            .search-box {
                width: 100%;
                min-width: 200px;
            }
            
            .controls-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .controls-left, .controls-right {
                width: 100%;
                justify-content: center;
            }
        }

        .search-box:focus {
            outline: none;
            border-color: #2E8B57;
        }

        .filter-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .filter-btn.active {
            background: #2E8B57;
            color: white;
            border-color: #2E8B57;
        }

        .filter-btn:hover {
            background: #e9ecef;
        }

        .filter-btn.active:hover {
            background: #228B22;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .refresh-btn {
            background: #2E8B57;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .refresh-btn:hover {
            background: #228B22;
        }

        .approve-all-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .approve-all-btn:hover {
            background: #218838;
        }

        .approve-all-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        /* ========== TABLAS RESPONSIVE ========== */
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .users-table, .devices-table, .renewals-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 800px;
        }

        .users-table th, .devices-table th, .renewals-table th {
            background: #2E8B57;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
        }

        .users-table td, .devices-table td, .renewals-table td {
            padding: 15px;
            border-bottom: 1px solid #e1e5e9;
            vertical-align: top;
        }

        .users-table tr:hover, .devices-table tr:hover, .renewals-table tr:hover {
            background: #f8f9fa;
        }

        /* ========== ESTILOS EXISTENTES (MANTENIDOS) ========== */
        .status-pending {
            background: #fff3cd;
            color: #856404;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-expiring {
            background: #ffeaa7;
            color: #e17055;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-expired {
            background: #fab1a0;
            color: #d63031;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .device-info {
            font-family: monospace;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            word-break: break-all;
        }

        .browser-info {
            font-size: 12px;
            color: #666;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .btn-approve {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
            transition: background 0.3s ease;
        }

        .btn-approve:hover {
            background: #218838;
        }

        .btn-reject {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
            transition: background 0.3s ease;
        }

        .btn-reject:hover {
            background: #c82333;
        }

        .btn-pending {
            background: #ffc107;
            color: black;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
            transition: background 0.3s ease;
        }

        .btn-pending:hover {
            background: #e0a800;
        }

        .action-buttons-container {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-users, .no-devices, .no-renewals {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .admin-login {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            position: relative;
        }

        .login-form input {
            padding: 12px 45px 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            width: 100%;
            transition: border-color 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: #2E8B57;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 18px;
            padding: 5px;
            border-radius: 4px;
            transition: color 0.3s ease;
        }

        .password-toggle:hover {
            color: #2E8B57;
            background: #f0f8f0;
        }

        .login-btn {
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        /* Modal para notas de rechazo */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
        }

        .modal-header h3 {
            color: #2E8B57;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .close-modal:hover {
            color: #dc3545;
        }

        .modal-textarea {
            width: 100%;
            height: 120px;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 20px;
        }

        .modal-textarea:focus {
            outline: none;
            border-color: #2E8B57;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .modal-btn.confirm {
            background: #dc3545;
            color: white;
        }

        .modal-btn.confirm:hover {
            background: #c82333;
        }

        .modal-btn.cancel {
            background: #6c757d;
            color: white;
        }

        .modal-btn.cancel:hover {
            background: #545b62;
        }

        /* ========== NUEVOS ESTILOS PARA MEJORAS UX ========== */
        
        /* Notificaciones Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid #28a745;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }

        .toast-error {
            border-left-color: #dc3545;
        }

        .toast-warning {
            border-left-color: #ffc107;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Loading spinner mejorado */
        .loading-spinner {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2E8B57;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Detalles de confirmaci√≥n */
        .confirmation-details {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
            border-left: 3px solid #2E8B57;
        }

        /* Scroll suave para toda la p√°gina */
        html {
            scroll-behavior: smooth;
        }

        /* Indicador visual del panel activo */
        .section-highlight {
            animation: highlight 2s ease;
        }

        @keyframes highlight {
            0% { background-color: rgba(46, 139, 87, 0.1); }
            100% { background-color: transparent; }
        }

        /* Mejoras responsive para botones de acci√≥n */
        @media (max-width: 768px) {
            .action-buttons-container {
                flex-direction: column;
                gap: 8px;
            }
            
            .action-buttons-container button {
                width: 100%;
                margin-right: 0;
            }
            
            .expiring-item {
                flex-direction: column;
                align-items: stretch;
            }
            
            .expiring-actions {
                justify-content: center;
                flex-wrap: wrap;
            }
        }
        /* üíÖ Estilo visual para la columna "Motivo del Rechazo" */
.users-table td:nth-child(6) {
  max-width: 250px;
  word-wrap: break-word;
  white-space: normal;
  text-align: left;
}

/* üíÖ Cuadro visual del motivo del rechazo con √≠cono */
.rejection-reason-box {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  font-size: 13px;
  color: #721c24;
  background-color: #f8d7da;
  border: 1px solid #f5c6cb;
  border-radius: 8px;
  padding: 8px 10px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* √çcono de advertencia */
.rejection-reason-box::before {
  content: "‚ö†Ô∏è";
  font-size: 16px;
  margin-top: 1px;
}
/* === Estilo del bot√≥n de WhatsApp === */
.btn-whatsapp {
    background-color: #25D366;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    cursor: pointer;
    font-size: 13px;
    transition: 0.2s;
}
.btn-whatsapp:hover {
    background-color: #1EBE57;
}
    </style>
</head>
<body>
    <!-- Panel de Administraci√≥n -->
    <div class="admin-container" id="adminPanel" style="display: none;">
        <div class="admin-header">
            <h1>üöÄ PANEL ADMINISTRATIVO</h1>
            <div class="subtitle">Lifehuni - Control de Usuarios y Dispositivos</div>
            <button class="logout-btn" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
        </div>

        <!-- ========== GLOBOS INTERACTIVOS MEJORADOS ========== -->
        <div class="stats-container">
            <div class="stat-card" onclick="navigateToSection('usersSection', 'all')">
                <span class="stat-icon">üë•</span>
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">Usuarios Totales</div>
                <div class="click-hint">Click para ver todos</div>
            </div>
            <div class="stat-card pending" onclick="navigateToSection('usersSection', 'pending')">
                <span class="stat-icon">‚è≥</span>
                <div class="stat-number" id="pendingUsers">0</div>
                <div class="stat-label">Pendientes de Aprobaci√≥n</div>
                <div class="click-hint">Click para revisar</div>
            </div>
            <div class="stat-card" onclick="navigateToSection('usersSection', 'approved')">
                <span class="stat-icon">‚úÖ</span>
                <div class="stat-number" id="approvedUsers">0</div>
                <div class="stat-label">Usuarios Aprobados</div>
                <div class="click-hint">Click para gestionar</div>
            </div>
            <div class="stat-card rejected" onclick="navigateToSection('usersSection', 'rejected')">
                <span class="stat-icon">‚ùå</span>
                <div class="stat-number" id="rejectedUsers">0</div>
                <div class="stat-label">Usuarios Rechazados</div>
                <div class="click-hint">Click para ver historial</div>
            </div>
            <div class="stat-card devices" onclick="navigateToSection('devicesSection', 'pending')">
                <span class="stat-icon">üö®</span>
                <div class="stat-number" id="pendingDevicesCount">0</div>
                <div class="stat-label">Dispositivos No Autorizados</div>
                <div class="click-hint">Click para autorizar</div>
            </div>
            <div class="stat-card renewals" onclick="navigateToSection('renewalsSection', 'all')">
                <span class="stat-icon">üîÑ</span>
                <div class="stat-number" id="pendingRenewalsCount">0</div>
                <div class="stat-label">Solicitudes de Renovaci√≥n</div>
                <div class="click-hint">Click para gestionar</div>
            </div>
        </div>

        <!-- ========== NUEVA SECCI√ìN PR√ìXIMOS A VENCER ========== -->
        <div class="expiring-section" id="expiringSection">
            <div class="expiring-header">
                <h3>üìÖ Pr√≥ximos a Vencer (7 d√≠as)</h3>
                <button class="refresh-btn" onclick="loadExpiringUsers()">üîÑ Actualizar</button>
            </div>
            <div class="expiring-list" id="expiringList">
                <div class="loading">Cargando usuarios pr√≥ximos a vencer...</div>
            </div>
        </div>

        <!-- Sistema de Tabs -->
        <div class="tab-container">
            <div class="tabs">
                <button class="tab active" onclick="showTab('users')">üë• Gesti√≥n de Usuarios</button>
                <button class="tab" onclick="showTab('devices')">üì± Autorizaci√≥n de Dispositivos</button>
                <button class="tab" onclick="showTab('renewals')">üîÑ Solicitudes de Renovaci√≥n</button>
            </div>
        </div>

        <!-- Secci√≥n Usuarios -->
        <div id="usersSection" class="content-section active">
            <div class="controls-container">
                <div class="controls-left">
                    <input type="text" id="searchInput" class="search-box" placeholder="üîç Buscar por email..." onkeyup="filterUsers()">
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="setFilter('all', this)">Todos</button>
                        <button class="filter-btn" onclick="setFilter('pending', this)">Pendientes</button>
                        <button class="filter-btn" onclick="setFilter('approved', this)">Aprobados</button>
                        <button class="filter-btn" onclick="setFilter('rejected', this)">Rechazados</button>
                    </div>
                </div>
                <div class="controls-right">
                    <div class="action-buttons">
                        <button class="approve-all-btn" id="approveAllBtn" onclick="approveAllPending()" disabled>‚úÖ Aprobar Todos</button>
                        <button class="refresh-btn" onclick="loadUsers()">üîÑ Actualizar</button>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <div id="usersTable">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p>Cargando usuarios...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n Dispositivos -->
        <div id="devicesSection" class="content-section">
            <div class="controls-container">
                <div class="controls-left">
                    <input type="text" id="searchDevicesInput" class="search-box" placeholder="üîç Buscar por email o dispositivo..." onkeyup="filterDevices()">
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="setDevicesFilter('all', this)">Todos</button>
                        <button class="filter-btn" onclick="setDevicesFilter('pending', this)">Pendientes</button>
                        <button class="filter-btn" onclick="setDevicesFilter('approved', this)">Autorizados</button>
                        <button class="filter-btn" onclick="setDevicesFilter('rejected', this)">Rechazados</button>
                    </div>
                </div>
                <div class="controls-right">
                    <div class="action-buttons">
                        <button class="refresh-btn" onclick="loadDevices()">üîÑ Actualizar</button>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <div id="devicesTable">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p>Cargando dispositivos...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== NUEVA SECCI√ìN SOLICITUDES DE RENOVACI√ìN ========== -->
        <div id="renewalsSection" class="content-section">
            <div class="controls-container">
                <div class="controls-left">
                    <h3 style="color: #2E8B57; margin: 0;">üîÑ Solicitudes de Renovaci√≥n</h3>
                    <p style="margin: 5px 0 0 0; color: #666;">Clientes que han solicitado renovar su suscripci√≥n</p>
                </div>
                <div class="controls-right">
                    <div class="action-buttons">
                        <button class="refresh-btn" onclick="loadRenewalRequests()">üîÑ Actualizar</button>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <div id="renewalsTable">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p>Cargando solicitudes de renovaci√≥n...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login para Admin -->
    <div class="admin-login" id="adminLogin">
        <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="color: #2E8B57;">üîê Acceso Administrativo</h2>
            <p>Lifehuni - Panel de Control</p>
        </div>
        <form class="login-form" id="loginForm">
            <div class="form-group">
                <input type="email" id="adminEmail" placeholder="Correo administrativo" required>
            </div>
            
            <div class="form-group">
                <input type="password" id="adminPassword" placeholder="Contrase√±a" required>
                <button type="button" class="password-toggle" onclick="togglePassword('adminPassword', this)">
                    üëÅÔ∏è
                </button>
            </div>
            
            <button type="submit" class="login-btn">Ingresar al Panel</button>
        </form>
    </div>

    <!-- Modal para notas de rechazo -->
    <div id="rejectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìù Motivo del Rechazo</h3>
                <button class="close-modal" onclick="closeRejectModal()">√ó</button>
            </div>
            <textarea id="rejectReason" class="modal-textarea" placeholder="Escribe el motivo del rechazo (opcional)..."></textarea>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeRejectModal()">Cancelar</button>
                <button class="modal-btn confirm" onclick="confirmReject()">Confirmar Rechazo</button>
            </div>
        </div>
    </div>

    <!-- Modal para confirmaciones mejoradas -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirmTitle">Confirmar Acci√≥n</h3>
                <button class="close-modal" onclick="closeConfirmationModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">¬øEst√°s seguro de que quieres realizar esta acci√≥n?</p>
                <div id="confirmDetails" class="confirmation-details"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeConfirmationModal()">Cancelar</button>
                <button class="modal-btn confirm" id="confirmActionBtn">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC-jbuu3oq0tOuvmwwgpoPL02oa9dqz0w0",
            authDomain: "experto-asesorvirtual-lifehuni.firebaseapp.com",
            projectId: "experto-asesorvirtual-lifehuni",
            storageBucket: "experto-asesorvirtual-lifehuni.appspot.com",
            messagingSenderId: "885294704059",
            appId: "1:885294704059:web:7c4d4d1b3d5d0d8c8c0c4c"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Variables globales
        let currentUser = null;
        let usersData = [];
        let devicesData = [];
        let renewalRequestsData = [];
        let currentFilter = 'all';
        let currentDevicesFilter = 'all';
        let userToReject = null;

        // ========== FUNCIONES DE AUTENTICACI√ìN ==========
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Verificar si es admin
                const userDoc = await db.collection('admins').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    showToast('‚úÖ Acceso concedido', 'success');
                    document.getElementById('adminLogin').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                    initializeAdminPanel();
                } else {
                    await auth.signOut();
                    showToast('‚ùå No tienes permisos de administrador', 'error');
                }
            } catch (error) {
                console.error('Error de login:', error);
                showToast('‚ùå Credenciales incorrectas', 'error');
            }
        });

        function logout() {
            auth.signOut().then(() => {
                currentUser = null;
                document.getElementById('adminPanel').style.display = 'none';
                document.getElementById('adminLogin').style.display = 'block';
                document.getElementById('loginForm').reset();
                showToast('üëã Sesi√≥n cerrada correctamente', 'success');
            });
        }

        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }

        // ========== INICIALIZACI√ìN DEL PANEL ==========
        function initializeAdminPanel() {
            loadUsers();
            loadDevices();
            loadRenewalRequests();
            loadExpiringUsers();
            
            // Configurar listener para cambios en tiempo real
            setupRealtimeListeners();
        }

        function setupRealtimeListeners() {
            // Escuchar cambios en usuarios
            db.collection('users').onSnapshot((snapshot) => {
                loadUsers();
            });

            // Escuchar cambios en dispositivos
            db.collection('pendingDevices').onSnapshot((snapshot) => {
                loadDevices();
            });

            // Escuchar cambios en renovaciones
            db.collection('renewalRequests').onSnapshot((snapshot) => {
                loadRenewalRequests();
            });
        }

        // ========== FUNCIONES DE NAVEGACI√ìN Y UI ==========
        function showTab(tabName) {
            // Ocultar todas las secciones
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar la secci√≥n seleccionada
            document.getElementById(tabName + 'Section').classList.add('active');
            
            // Actualizar tabs activos
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }

       function navigateToSection(sectionId, filter = 'all') {
    // Mostrar la secci√≥n correspondiente
    if (sectionId === 'usersSection') {
        showTab('users');
        setFilter(filter);
    } else if (sectionId === 'devicesSection') {
        showTab('devices');
        setDevicesFilter(filter);
    } else if (sectionId === 'renewalsSection') {
        showTab('renewals');
    }
    
    // A√±adir efecto de highlight
    const section = document.getElementById(sectionId);
    section.classList.add('section-highlight');
    setTimeout(() => {
        section.classList.remove('section-highlight');
    }, 2000);

    // ‚úÖ NUEVO: desplazamiento autom√°tico hacia la secci√≥n activa (especialmente √∫til en m√≥viles)
    setTimeout(() => {
        section.scrollIntoView({
            behavior: "smooth",
            block: "start"
        });
    }, 300);
}

        // ‚úÖ Compatibilidad t√°ctil mejorada: doble toque en m√≥viles para evitar toques accidentales
document.addEventListener('DOMContentLoaded', () => {
  const statCards = document.querySelectorAll('.stat-card');
  let lastTapTime = 0;

  statCards.forEach(card => {
    card.addEventListener('touchstart', function (e) {
      const currentTime = new Date().getTime();
      const tapLength = currentTime - lastTapTime;

      if (tapLength < 400 && tapLength > 0) {
        // Doble toque detectado ‚Üí ejecutar la acci√≥n
        this.click();
      } else {
        // Primer toque ‚Üí mostrar un peque√±o aviso visual opcional
        card.classList.add('ready-tap');
        setTimeout(() => card.classList.remove('ready-tap'), 500);
      }

      lastTapTime = currentTime;
    }, { passive: true });
  });
});

// ‚úÖ Funcionalidad para ordenar columnas al hacer clic en la cabecera
let currentSort = { column: null, direction: 1 }; // 1 = ascendente, -1 = descendente

// Funci√≥n principal para ordenar y redibujar la tabla
function sortUsersBy(columnKey) {
  // Si vuelven a hacer clic sobre la misma columna, invierte el orden
  if (currentSort.column === columnKey) {
    currentSort.direction *= -1;
  } else {
    currentSort.column = columnKey;
    currentSort.direction = 1;
  }

  // Ordenar seg√∫n la columna seleccionada
  usersData.sort((a, b) => {
    let valA = a[columnKey] || "";
    let valB = b[columnKey] || "";

    // Si es fecha, convertir a Date
    if (columnKey === "registerDate") {
      try {
        valA = new Date(a.registerDate || 0);
        valB = new Date(b.registerDate || 0);
      } catch {
        valA = new Date(0);
        valB = new Date(0);
      }
    }

    // Si es dispositivo, leer la informaci√≥n de dispositivo
    if (columnKey === "deviceInfo") {
      try {
        const devA = a.deviceInfo || {};
        const devB = b.deviceInfo || {};
        valA = (devA.platform || devA.browser || "").toString().toLowerCase();
        valB = (devB.platform || devB.browser || "").toString().toLowerCase();
      } catch {
        valA = "";
        valB = "";
      }
    }

    // Comparar alfab√©ticamente o por fecha
    if (valA < valB) return -1 * currentSort.direction;
    if (valA > valB) return 1 * currentSort.direction;
    return 0;
  });

  // Redibujar tabla de usuarios
  displayUsers();
}
        // ========== GESTI√ìN DE USUARIOS ==========
        async function loadUsers() {
            try {
                const usersSnapshot = await db.collection('users').get();
                usersData = [];
                
                usersSnapshot.forEach(doc => {
    const userData = doc.data();
    
    // ‚úÖ CORRECCI√ìN: Asegurar que todos los campos tengan valores por defecto
    usersData.push({
        id: doc.id,
        name: userData.name || 'No proporcionado',
        email: userData.email || 'No disponible',
        phone: userData.phone || 'No disponible',
        status: userData.status || 'pending',
        registerDate: userData.registerDate || userData.createdAt || 'No registrada',
        deviceInfo: userData.deviceInfo || '{}',
        ...userData
    });
});

                updateUsersStats();
                displayUsers();
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                showToast('‚ùå Error al cargar usuarios', 'error');
            }
        }

        function updateUsersStats() {
            const totalUsers = usersData.length;
            const pendingUsers = usersData.filter(user => user.status === 'pending').length;
            const approvedUsers = usersData.filter(user => user.status === 'approved').length;
            const rejectedUsers = usersData.filter(user => user.status === 'rejected').length;

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('pendingUsers').textContent = pendingUsers;
            document.getElementById('approvedUsers').textContent = approvedUsers;
            document.getElementById('rejectedUsers').textContent = rejectedUsers;

            // Habilitar/deshabilitar bot√≥n de aprobar todos
            document.getElementById('approveAllBtn').disabled = pendingUsers === 0;
        }

        function displayUsers() {
            const usersTable = document.getElementById('usersTable');
            const filteredUsers = filterUsersData();
            
            if (filteredUsers.length === 0) {
                usersTable.innerHTML = `
                    <div class="no-users">
                        <p>üì≠ No se encontraron usuarios</p>
                        <p style="font-size: 12px; margin-top: 10px;">No hay usuarios que coincidan con el filtro actual</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="users-table">
  <thead>
    <tr>
      <th onclick="sortUsersBy('name')" style="cursor:pointer;">Usuario ‚¨ç</th>
      <th onclick="sortUsersBy('email')" style="cursor:pointer;">Email ‚¨ç</th>
      <th>Estado</th>
      <th onclick="sortUsersBy('registerDate')" style="cursor:pointer;">Fecha Registro ‚¨ç</th>
      <th onclick="sortUsersBy('deviceInfo')" style="cursor:pointer;">Dispositivo ‚¨ç</th>
      <th>Motivo del Rechazo</th>
      <th>Acciones</th>
    </tr>
  </thead>
                    <tbody>
            `;

            filteredUsers.forEach(user => {
    // ‚úÖ CORRECCI√ìN MEJORADA: Manejar fechas y dispositivos
    let registerDate = 'No registrada';
    try {
        if (user.registerDate) {
            // Si registerDate es un Timestamp de Firebase
            if (user.registerDate.toDate) {
                registerDate = user.registerDate.toDate().toLocaleDateString();
            } else {
                // Si es string ISO
                registerDate = new Date(user.registerDate).toLocaleDateString();
            }
        } else if (user.createdAt && user.createdAt.toDate) {
            registerDate = user.createdAt.toDate().toLocaleDateString();
        }
    } catch (error) {
        registerDate = 'Fecha inv√°lida';
    }

    // ‚úÖ CORRECCI√ìN MEJORADA: Manejar informaci√≥n del dispositivo
    let deviceInfo = {};
    let browser = 'No detectado';
    let platform = 'No detectado';
    
    try {
        if (user.deviceInfo && typeof user.deviceInfo === 'string') {
            deviceInfo = JSON.parse(user.deviceInfo);
        } else if (user.deviceInfo && typeof user.deviceInfo === 'object') {
            deviceInfo = user.deviceInfo;
        }
        
        // Buscar informaci√≥n del dispositivo en diferentes ubicaciones
        if (user.devices && user.currentDevice) {
            const currentDevice = user.devices[user.currentDevice];
            if (currentDevice && currentDevice.deviceInfo) {
                deviceInfo = currentDevice.deviceInfo;
            }
        }
        
        browser = deviceInfo.browser || 
                 (deviceInfo.userAgent && deviceInfo.userAgent.includes('Chrome') ? 'Chrome' : 
                  deviceInfo.userAgent && deviceInfo.userAgent.includes('Firefox') ? 'Firefox' : 
                  deviceInfo.userAgent && deviceInfo.userAgent.includes('Safari') ? 'Safari' : 
                  'Navegador');
                  
        platform = deviceInfo.platform || 
                  (deviceInfo.userAgent && deviceInfo.userAgent.includes('Mobile') ? 'M√≥vil' : 
                   'Escritorio');
                   
    } catch (error) {
        console.log('Error procesando dispositivo:', error);
    }

    html += `
    <tr>
        <td>
            <strong>${user.name}</strong>
            ${user.phone && user.phone !== 'No disponible' ? `<br><small>üìû ${user.phone}</small>` : ''}
        </td>
            <td>${user.email}</td>
            <td>
                <span class="status-${user.status}">
                    ${getStatusText(user.status)}
                </span>
            </td>
            <td>${registerDate}</td>
            <td>
                <div class="device-info">
                    <strong>${platform}</strong><br>
                    <small class="browser-info">${browser}</small>
                </div>
            </td>
          <td>
    ${user.status === 'rejected' ? `
        <div class="rejection-reason-box">
            ${user.rejectionReason || 'Sin motivo registrado'}
        </div>
    ` : '-'}
</td>
            <td>
                <div class="action-buttons-container">
                    ${user.status === 'pending' ? `
                        <button class="btn-approve" onclick="approveUser('${user.id}')">‚úÖ Aprobar</button>
                        <button class="btn-reject" onclick="openRejectModal('${user.id}')">‚ùå Rechazar</button>
                    ` : ''}
                    
                    ${user.status === 'approved' ? `
                        <button class="btn-reject" onclick="openRejectModal('${user.id}')">‚ùå Rechazar</button>
                        <button class="btn-pending" onclick="setUserStatus('${user.id}', 'pending')">‚è≥ Pendiente</button>
                    ` : ''}
                    
                    ${user.status === 'rejected' ? `
                        <button class="btn-approve" onclick="approveUser('${user.id}')">‚úÖ Aprobar</button>
                        <button class="btn-pending" onclick="setUserStatus('${user.id}', 'pending')">‚è≥ Pendiente</button>
                    ` : ''}
                </div>
            </td>
        </tr>
    `;
});

            html += `</tbody></table>`;
            usersTable.innerHTML = html;
        }

        function filterUsersData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = usersData.filter(user => 
                user.email.toLowerCase().includes(searchTerm) ||
                (user.name && user.name.toLowerCase().includes(searchTerm)) ||
                (user.phone && user.phone.includes(searchTerm))
            );

            if (currentFilter !== 'all') {
                filtered = filtered.filter(user => user.status === currentFilter);
            }

            return filtered;
        }

        function filterUsers() {
            displayUsers();
        }

        function setFilter(filter, element = null) {
            currentFilter = filter;
            
            if (element) {
                document.querySelectorAll('.filter-buttons .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                element.classList.add('active');
            }
            
            displayUsers();
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'Pendiente',
                'approved': 'Aprobado',
                'rejected': 'Rechazado'
            };
            return statusMap[status] || status;
        }

        // ========== GESTI√ìN DE DISPOSITIVOS ==========
        async function loadDevices() {
    try {
        console.log("üîÑ Cargando dispositivos desde Firestore...");
        
        const devicesSnapshot = await db.collection('pendingDevices').get();
        console.log("üìä Dispositivos encontrados:", devicesSnapshot.size);
        
        devicesData = [];
        devicesSnapshot.forEach(doc => {
            const deviceData = doc.data();
            console.log("üìÑ Documento:", doc.id, deviceData);
            
            devicesData.push({
                id: doc.id,
                userEmail: deviceData.userEmail || 'No disponible',
                userName: deviceData.userName || 'No disponible',
                userPhone: deviceData.userPhone || 'No disponible',
                deviceFingerprint: deviceData.deviceFingerprint || 'No disponible',
                deviceInfo: deviceData.deviceInfo || {},
                timestamp: deviceData.timestamp || deviceData.attemptedAt || new Date().toISOString(),
                status: deviceData.status || 'pending',
                ...deviceData
            });
        });

        console.log("‚úÖ Dispositivos procesados:", devicesData);
        updateDevicesStats();
        displayDevices();
        
    } catch (error) {
        console.error('‚ùå Error cargando dispositivos:', error);
        console.error('Detalles:', error.message, error.code);
        showToast('‚ùå Error al cargar dispositivos: ' + error.message, 'error');
    }
}

        function updateDevicesStats() {
            const pendingDevices = devicesData.filter(device => device.status === 'pending').length;
            document.getElementById('pendingDevicesCount').textContent = pendingDevices;
        }

        function displayDevices() {
    const devicesTable = document.getElementById('devicesTable');
    const filteredDevices = filterDevicesData();
    
    console.log("üìã Mostrando dispositivos filtrados:", filteredDevices.length);

    if (filteredDevices.length === 0) {
        devicesTable.innerHTML = `
            <div class="no-devices">
                <p>üì± No se encontraron dispositivos</p>
                <p style="font-size: 12px; margin-top: 10px;">
                    ${devicesData.length === 0 ? 
                      'No hay dispositivos pendientes de autorizaci√≥n' : 
                      'No hay dispositivos que coincidan con el filtro actual'}
                </p>
                ${devicesData.length > 0 ? `
                    <button class="refresh-btn" onclick="loadDevices()" style="margin-top: 10px;">
                        üîÑ Mostrar Todos
                    </button>
                ` : ''}
            </div>
        `;
        return;
    }

    let html = `
        <table class="devices-table">
            <thead>
                <tr>
                    <th>Usuario</th>
                    <th>Email</th>
                    <th>Dispositivo</th>
                    <th>Navegador</th>
                    <th>Fecha Solicitud</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
    `;

    filteredDevices.forEach(device => {
        console.log("üìù Procesando dispositivo:", device.id, device);
        
        const requestDate = device.timestamp ? 
            new Date(device.timestamp).toLocaleDateString('es-CO') : 
            'No registrada';
        
        const deviceInfo = device.deviceInfo || {};
        const browser = deviceInfo.browser || 
                       (deviceInfo.userAgent && deviceInfo.userAgent.includes('Chrome') ? 'Chrome' : 
                        deviceInfo.userAgent && deviceInfo.userAgent.includes('Firefox') ? 'Firefox' : 
                        deviceInfo.userAgent && deviceInfo.userAgent.includes('Safari') ? 'Safari' : 
                        'No detectado');
        
        const platform = deviceInfo.platform || 
                        (deviceInfo.userAgent && deviceInfo.userAgent.includes('Mobile') ? 'M√≥vil' : 
                         'Escritorio');

        html += `
            <tr>
                <td>
                    <strong>${device.userName}</strong>
                    ${device.userPhone ? `<br><small>üìû ${device.userPhone}</small>` : ''}
                    ${device.deviceFingerprint ? `<br><small style="color: #666; font-size: 10px;">ID: ${device.deviceFingerprint.substring(0, 8)}...</small>` : ''}
                </td>
                <td>${device.userEmail}</td>
                <td>
                    <div class="device-info">
                        <strong>${platform}</strong>
                        ${deviceInfo.model ? `<br><small>Modelo: ${deviceInfo.model}</small>` : ''}
                        ${deviceInfo.vendor ? `<br><small>Fabricante: ${deviceInfo.vendor}</small>` : ''}
                        ${deviceInfo.screenResolution ? `<br><small>Resoluci√≥n: ${deviceInfo.screenResolution}</small>` : ''}
                    </div>
                </td>
                <td>
                    <div class="browser-info">${browser}</div>
                    ${deviceInfo.version ? `<small>v${deviceInfo.version}</small>` : ''}
                    ${deviceInfo.language ? `<br><small>Idioma: ${deviceInfo.language}</small>` : ''}
                </td>
                <td>${requestDate}</td>
                <td>
                    <span class="status-${device.status}">
                        ${getDeviceStatusText(device.status)}
                    </span>
                </td>
                <td>
                    <div class="action-buttons-container">
                        ${device.status === 'pending' ? `
                            <button class="btn-approve" onclick="approveDevice('${device.id}')">‚úÖ Autorizar</button>
                            <button class="btn-reject" onclick="rejectDevice('${device.id}')">‚ùå Rechazar</button>
                        ` : ''}
                        
                        ${device.status === 'approved' ? `
                            <button class="btn-reject" onclick="rejectDevice('${device.id}')">‚ùå Revocar</button>
                        ` : ''}
                        
                        ${device.status === 'rejected' ? `
                            <button class="btn-approve" onclick="approveDevice('${device.id}')">‚úÖ Autorizar</button>
                        ` : ''}
                        
                        <button class="btn-pending" onclick="showDeviceDetails('${device.id}')" 
                                style="background: #17a2b8; color: white; margin-top: 5px;">
                            üîç Detalles
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    html += `</tbody></table>`;
    devicesTable.innerHTML = html;
    
    console.log("‚úÖ Tabla de dispositivos renderizada");
}

        function filterDevicesData() {
            const searchTerm = document.getElementById('searchDevicesInput').value.toLowerCase();
            
            let filtered = devicesData.filter(device => 
                device.userEmail.toLowerCase().includes(searchTerm) ||
                (device.userName && device.userName.toLowerCase().includes(searchTerm)) ||
                (device.deviceInfo && JSON.stringify(device.deviceInfo).toLowerCase().includes(searchTerm))
            );

            if (currentDevicesFilter !== 'all') {
                filtered = filtered.filter(device => device.status === currentDevicesFilter);
            }

            return filtered;
        }

        function filterDevices() {
            displayDevices();
        }

        function setDevicesFilter(filter, element = null) {
            currentDevicesFilter = filter;
            
            if (element) {
                document.querySelectorAll('.filter-buttons .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                element.classList.add('active');
            }
            
            displayDevices();
        }

        function getDeviceStatusText(status) {
            const statusMap = {
                'pending': 'Pendiente',
                'approved': 'Autorizado',
                'rejected': 'Rechazado'
            };
            return statusMap[status] || status;
        }

        // ========== APROBACI√ìN Y RECHAZO DE USUARIOS ==========
       function approveUser(userId) {
    const expirationDate = new Date();
    expirationDate.setDate(expirationDate.getDate() + 30); // 30 d√≠as desde hoy

    db.collection("users").doc(userId).update({
        status: "approved",
        renewalDate: expirationDate.toISOString() // guardamos la fecha en formato ISO
    }).then(() => {
        alert("‚úÖ Usuario aprobado correctamente.\nFecha de vencimiento: " + expirationDate.toLocaleDateString());
        displayUsers();
        loadExpiringUsers(); // recargamos la secci√≥n amarilla
    });
}

        async function approveAllPending() {
            const pendingUsers = usersData.filter(user => user.status === 'pending');
            
            if (pendingUsers.length === 0) {
                showToast('‚ÑπÔ∏è No hay usuarios pendientes por aprobar', 'warning');
                return;
            }

            try {
                const batch = db.batch();
                const timestamp = new Date().toISOString();
                
                pendingUsers.forEach(user => {
                    const userRef = db.collection('users').doc(user.id);
                    batch.update(userRef, {
                        status: 'approved',
                        approvedAt: timestamp,
                        approvedBy: currentUser.email
                    });
                });
                
                await batch.commit();
                showToast(`‚úÖ ${pendingUsers.length} usuarios aprobados correctamente`, 'success');
                loadUsers();
            } catch (error) {
                console.error('Error aprobando usuarios:', error);
                showToast('‚ùå Error al aprobar usuarios', 'error');
            }
        }

        function openRejectModal(userId) {
            userToReject = userId;
            document.getElementById('rejectModal').style.display = 'block';
            document.getElementById('rejectReason').value = '';
        }

        function closeRejectModal() {
            document.getElementById('rejectModal').style.display = 'none';
            userToReject = null;
        }

        async function confirmReject() {
            if (!userToReject) return;
            
            const reason = document.getElementById('rejectReason').value;
            
            try {
                await db.collection('users').doc(userToReject).update({
                    status: 'rejected',
                    rejectedAt: new Date().toISOString(),
                    rejectedBy: currentUser.email,
                    rejectionReason: reason || 'Sin motivo especificado'
                });
                
                showToast('‚ùå Usuario rechazado correctamente', 'success');
                closeRejectModal();
                loadUsers();
            } catch (error) {
                console.error('Error rechazando usuario:', error);
                showToast('‚ùå Error al rechazar usuario', 'error');
            }
        }

        async function setUserStatus(userId, status) {
            try {
                const updateData = {
                    status: status
                };
                
                if (status === 'approved') {
                    updateData.approvedAt = new Date().toISOString();
                    updateData.approvedBy = currentUser.email;
                } else if (status === 'rejected') {
                    updateData.rejectedAt = new Date().toISOString();
                    updateData.rejectedBy = currentUser.email;
                }
                
                await db.collection('users').doc(userId).update(updateData);
                
                showToast(`‚úÖ Estado actualizado a: ${getStatusText(status)}`, 'success');
                loadUsers();
            } catch (error) {
                console.error('Error actualizando estado:', error);
                showToast('‚ùå Error al actualizar estado', 'error');
            }
        }

        // ========== GESTI√ìN DE DISPOSITIVOS ==========

async function approveDevice(deviceId) {
    try {
        // 1. ‚úÖ ENCONTRAR EL DISPOSITIO EN LA LISTA
        const device = devicesData.find(d => d.id === deviceId);
        if (!device) {
            showToast('‚ùå Dispositivo no encontrado', 'error');
            return;
        }

        console.log("‚úÖ Autorizando dispositivo:", device);

        // 2. ‚úÖ ACTUALIZAR pendingDevices
        await db.collection('pendingDevices').doc(deviceId).update({
            status: 'approved',
            approvedAt: new Date().toISOString(),
            approvedBy: currentUser.email
        });

        // 3. ‚úÖ ACTUALIZAR users - AGREGAR DISPOSITIO AUTORIZADO
        if (device.userId) {
            const userRef = db.collection('users').doc(device.userId);
            const userDoc = await userRef.get();
            
            if (userDoc.exists) {
                const deviceInfo = device.deviceInfo || {};
                const currentTimestamp = new Date().toISOString();
                
                await userRef.update({
                    [`devices.${device.deviceFingerprint}`]: {
                        deviceInfo: deviceInfo,
                        registeredAt: currentTimestamp,
                        isActive: true,
                        lastLogin: currentTimestamp,
                        approvedBy: currentUser.email,
                        approvedAt: currentTimestamp
                    },
                    currentDevice: device.deviceFingerprint,
                    // Limpiar de pendingDevices del usuario
                    [`pendingDevices.${device.deviceFingerprint}`]: firebase.firestore.FieldValue.delete()
                });

                console.log("‚úÖ Dispositivo agregado al usuario:", device.userId);
                showToast('‚úÖ Dispositivo autorizado correctamente - Usuario actualizado', 'success');
            } else {
                console.warn("‚ö†Ô∏è Usuario no encontrado:", device.userId);
                showToast('‚úÖ Dispositivo autorizado (pero usuario no encontrado)', 'warning');
            }
        } else {
            console.warn("‚ö†Ô∏è No hay userId en el dispositivo");
            showToast('‚úÖ Dispositivo autorizado (pero sin userId)', 'warning');
        }

        // 4. ‚úÖ ACTUALIZAR INTERFAZ
        // Recargar la lista despu√©s de un breve delay
        setTimeout(() => {
            loadDevices();
        }, 1000);

    } catch (error) {
        console.error('‚ùå Error autorizando dispositivo:', error);
        showToast('‚ùå Error al autorizar dispositivo: ' + error.message, 'error');
    }
}

// ‚úÖ FUNCI√ìN FALTANTE - Rechazar dispositivo
async function rejectDevice(deviceId) {
    try {
        const device = devicesData.find(d => d.id === deviceId);
        if (!device) {
            showToast('‚ùå Dispositivo no encontrado', 'error');
            return;
        }

        await db.collection('pendingDevices').doc(deviceId).update({
            status: 'rejected',
            rejectedAt: new Date().toISOString(),
            rejectedBy: currentUser.email
        });

        showToast('‚ùå Dispositivo rechazado correctamente', 'success');
        loadDevices();
        
    } catch (error) {
        console.error('Error rechazando dispositivo:', error);
        showToast('‚ùå Error al rechazar dispositivo', 'error');
    }
}

// ‚úÖ FUNCI√ìN MEJORADA - Ver detalles del dispositivo
function showDeviceDetails(deviceId) {
    const device = devicesData.find(d => d.id === deviceId);
    if (!device) return;
    
    const deviceInfo = device.deviceInfo || {};
    const detailsHtml = `
        <strong>Usuario:</strong> ${device.userName}<br>
        <strong>Email:</strong> ${device.userEmail}<br>
        <strong>Tel√©fono:</strong> ${device.userPhone || 'No disponible'}<br>
        <strong>Fingerprint:</strong> ${device.deviceFingerprint}<br>
        <strong>Estado:</strong> ${device.status}<br>
        <strong>Fecha:</strong> ${device.timestamp}<br>
        <strong>Navegador:</strong> ${deviceInfo.browser || 'No detectado'}<br>
        <strong>Plataforma:</strong> ${deviceInfo.platform || 'No detectado'}<br>
        <strong>Resoluci√≥n:</strong> ${deviceInfo.screenResolution || 'No detectada'}
    `;
    
    openConfirmationModal(
        'üîç Detalles del Dispositivo', 
        'Informaci√≥n completa del dispositivo:',
        detailsHtml,
        () => {}
    );
}

        // ========== GESTI√ìN DE RENOVACIONES ==========
        async function loadRenewalRequests() {
            try {
                const renewalsSnapshot = await db.collection('renewalRequests').get();
                renewalRequestsData = [];
                
                renewalsSnapshot.forEach(doc => {
                    renewalRequestsData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                updateRenewalsStats();
                displayRenewalRequests();
            } catch (error) {
                console.error('Error cargando renovaciones:', error);
                showToast('‚ùå Error al cargar solicitudes de renovaci√≥n', 'error');
            }
        }

        function updateRenewalsStats() {
            const pendingRenewals = renewalRequestsData.filter(req => req.status === 'pending').length;
            document.getElementById('pendingRenewalsCount').textContent = pendingRenewals;
        }

        function displayRenewalRequests() {
    const renewalsTable = document.getElementById('renewalsTable');
    
    if (renewalRequestsData.length === 0) {
        renewalsTable.innerHTML = `
            <div class="no-renewals">
                <p>üîÑ No hay solicitudes de renovaci√≥n</p>
                <p style="font-size: 12px; margin-top: 10px;">Los clientes aparecer√°n aqu√≠ cuando soliciten renovar su suscripci√≥n</p>
            </div>
        `;
        return;
    }

    let html = `
        <table class="renewals-table">
            <thead>
                <tr>
                    <th>Usuario</th>
                    <th>Email</th>
                    <th>Fecha Solicitud</th>
                    <th>Estado</th>
                    <th>Plan Actual</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
    `;

    renewalRequestsData.forEach(request => {
        const requestDate = request.requestDate ? new Date(request.requestDate).toLocaleDateString() : 'No registrada';
        const currentPlan = request.currentPlan || 'No especificado';
        const userEmail = request.userEmail || 'No disponible';

        html += `
            <tr>
                <td>
                    <strong>${request.userName || 'No disponible'}</strong>
                    ${request.userPhone ? `<br><small>üìû ${request.userPhone}</small>` : ''}
                </td>
                <td>${userEmail}</td>
                <td>${requestDate}</td>
                <td>
                    <span class="status-${request.status}">
                        ${getRenewalStatusText(request.status)}
                    </span>
                </td>
                <td>${currentPlan}</td>
                <td>
                    <div class="action-buttons-container">
                        ${request.status === 'pending' ? `
                            <button class="btn-approve" onclick="approveRenewal('${request.id}')">‚úÖ Aprobar</button>
                            <button class="btn-reject" onclick="rejectRenewal('${request.id}')">‚ùå Rechazar</button>
                        ` : ''}

                        ${request.status === 'approved' ? `
                            <button class="btn-reject" onclick="rejectRenewal('${request.id}')">‚ùå Revocar</button>
                        ` : ''}

                        ${request.status === 'rejected' ? `
                            <button class="btn-approve" onclick="approveRenewal('${request.id}')">‚úÖ Re-activar</button>
                        ` : ''}

                        <!-- üì± Nuevo bot√≥n de WhatsApp -->
                        <button class="btn-whatsapp" onclick="contactClientByWhatsApp('${userEmail}')">üì± WhatsApp</button>
                    </div>
                </td>
            </tr>
        `;
    });

    html += `</tbody></table>`;
    renewalsTable.innerHTML = html;
}

        function getRenewalStatusText(status) {
            const statusMap = {
                'pending': 'Pendiente',
                'approved': 'Aprobada',
                'rejected': 'Rechazada'
            };
            return statusMap[status] || status;
        }

        async function approveRenewal(requestId) {
            try {
                await db.collection('renewalRequests').doc(requestId).update({
                    status: 'approved',
                    approvedAt: new Date().toISOString(),
                    approvedBy: currentUser.email
                });
                
                showToast('‚úÖ Renovaci√≥n aprobada correctamente', 'success');
                loadRenewalRequests();
            } catch (error) {
                console.error('Error aprobando renovaci√≥n:', error);
                showToast('‚ùå Error al aprobar renovaci√≥n', 'error');
            }
        }

        async function rejectRenewal(requestId) {
            try {
                await db.collection('renewalRequests').doc(requestId).update({
                    status: 'rejected',
                    rejectedAt: new Date().toISOString(),
                    rejectedBy: currentUser.email
                });
                
                showToast('‚ùå Renovaci√≥n rechazada correctamente', 'success');
                loadRenewalRequests();
            } catch (error) {
                console.error('Error rechazando renovaci√≥n:', error);
                showToast('‚ùå Error al rechazar renovaci√≥n', 'error');
            }
        }

        // ========== USUARIOS PR√ìXIMOS A VENCER ==========
        async function loadExpiringUsers() {
            try {
                const expiringSection = document.getElementById('expiringSection');
                const expiringList = document.getElementById('expiringList');
                
                // Por ahora, mostrar mensaje informativo
                expiringList.innerHTML = `
                   <div id="expiringUsersList" style="text-align:left; padding:10px; font-size:15px; color:#333;">
                    <p>üîÑ Cargando usuarios pr√≥ximos a vencer...</p>
                 </div>
                `;
                
                expiringSection.classList.add('active');
            } catch (error) {
                console.error('Error cargando usuarios pr√≥ximos a vencer:', error);
            }
        }

        // ========== UTILIDADES ==========
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'toast-error' : type === 'warning' ? 'toast-warning' : ''}`;
            toast.innerHTML = `
                <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è'}</span>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function openConfirmationModal(title, message, details, confirmCallback) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmDetails').innerHTML = details;
            
            const confirmBtn = document.getElementById('confirmActionBtn');
            confirmBtn.onclick = function() {
                confirmCallback();
                closeConfirmationModal();
            };
            
            document.getElementById('confirmationModal').style.display = 'block';
        }

        function closeConfirmationModal() {
            document.getElementById('confirmationModal').style.display = 'none';
        }

    // ‚úÖ Asegurar que currentUser siempre est√© disponible antes de ejecutar acciones
auth.onAuthStateChanged(async (user) => {
    if (user) {
        console.log("üîç Verificando permisos de administrador para:", user.email);
        
        try {
            const userDoc = await db.collection('admins').doc(user.uid).get();
            
            if (userDoc.exists) {
                // ‚úÖ USUARIO ES ADMIN - PERMITIR ACCESO
                currentUser = user;
                console.log("‚úÖ Acceso administrativo concedido a:", user.email);
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('adminLogin').style.display = 'none';
                
                // Inicializar el panel solo si no est√° ya inicializado
                if (typeof initializeAdminPanel === 'function') {
                    initializeAdminPanel();
                }
            } else {
                // ‚ùå USUARIO NO ES ADMIN - CERRAR SESI√ìN
                console.warn("‚ùå Usuario no tiene permisos de administrador:", user.email);
                await auth.signOut();
                showToast('‚ùå No tienes permisos de administrador', 'error');
            }
        } catch (error) {
            console.error('Error verificando permisos:', error);
            showToast('‚ùå Error verificando permisos de administrador', 'error');
        }
    } else {
        // üîê MOSTRAR LOGIN - NO HAY USUARIO AUTENTICADO
        console.log("üîê Mostrando formulario de login");
        document.getElementById('adminPanel').style.display = 'none';
        document.getElementById('adminLogin').style.display = 'block';
    }
});

// üîç FUNCI√ìN PARA VER DETALLES DEL DISPOSITIVO
function showDeviceDetails(deviceId) {
    const device = devicesData.find(d => d.id === deviceId);
    if (!device) return;
    
    console.log("üîç Detalles completos del dispositivo:", device);
    
    const deviceInfo = JSON.stringify(device.deviceInfo, null, 2);
    
    alert(`üìã DETALLES DEL DISPOSITIVO\n\n
Usuario: ${device.userName}
Email: ${device.userEmail}
Tel√©fono: ${device.userPhone || 'No disponible'}
Fingerprint: ${device.deviceFingerprint}
Estado: ${device.status}
Fecha: ${device.timestamp}

üì± INFORMACI√ìN DEL DISPOSITIVO:
${deviceInfo}

ID del documento: ${device.id}
    `);
}
    </script>

    <script>
        
async function loadExpiringUsers() {
  const list = document.getElementById("expiringUsersList");
  list.innerHTML = "<p>üîÑ Cargando usuarios pr√≥ximos a vencer...</p>";

  const today = new Date();
  const nextWeek = new Date();
  nextWeek.setDate(today.getDate() + 7);

  try {
    const snapshot = await db.collection("users")
      .where("status", "==", "approved")
      .get();

    let expiringUsers = [];

    snapshot.forEach(doc => {
      const user = doc.data();
      if (user.renewalDate) {
        const renewal = new Date(user.renewalDate);
        if (renewal >= today && renewal <= nextWeek) {
          const diffDays = Math.ceil((renewal - today) / (1000 * 60 * 60 * 24));
          expiringUsers.push({
            name: user.name || "Usuario sin nombre",
            email: user.email,
            days: diffDays,
            renewal: renewal.toLocaleDateString()
          });
        }
      }
    });

    if (expiringUsers.length === 0) {
      list.innerHTML = "<p>‚úÖ No hay usuarios pr√≥ximos a vencer en los pr√≥ximos 7 d√≠as.</p>";
      return;
    }

    let html = `
      <table style="width:100%; border-collapse:collapse; font-size:14px;">
        <thead>
          <tr style="background:#fff8e1;">
            <th style="text-align:left; padding:6px;">Usuario</th>
            <th style="text-align:left; padding:6px;">Correo</th>
            <th style="text-align:center; padding:6px;">D√≠as Restantes</th>
            <th style="text-align:center; padding:6px;">Vence el</th>
          </tr>
        </thead>
        <tbody>
    `;

    expiringUsers.forEach(u => {
      html += `
        <tr style="border-top:1px solid #eee;">
          <td style="padding:6px;">${u.name}</td>
          <td style="padding:6px;">${u.email}</td>
          <td style="text-align:center; padding:6px;">${u.days} d√≠as</td>
          <td style="text-align:center; padding:6px;">${u.renewal}</td>
        </tr>
      `;
    });

    html += "</tbody></table>";
    list.innerHTML = html;

  } catch (error) {
    console.error("Error cargando usuarios pr√≥ximos a vencer:", error);
    list.innerHTML = "<p style='color:red;'>‚ö†Ô∏è Error al cargar los datos.</p>";
  }
}

// Llamamos la funci√≥n cuando cargue el panel
document.addEventListener("DOMContentLoaded", loadExpiringUsers);

// ‚úÖ Funci√≥n para contactar al cliente por WhatsApp
function contactClientByWhatsApp(clientEmail) {
    const phoneNumber = "573023706402"; // tu n√∫mero de WhatsApp (admin)
    const message = encodeURIComponent(
        `Hola ${clientEmail}, soy del equipo Experto Asesor Virtual LifeHuni. Vimos tu solicitud de renovaci√≥n. ¬øDeseas continuar con el proceso?`
    );
    const url = `https://wa.me/${phoneNumber}?text=${message}`;
    window.open(url, "_blank");
}

</script>
    </body>
</html>